<!DOCTYPE html>
<html lang="en">
<head>
    <base href="/" />
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Registrations - Free Fire Tournament</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Custom Fonts from Google Fonts */
        @import url('https://fonts.googleapis.com/css2?family=Oxanium:wght@500;700&family=Inter:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            /* Light, clean, airy background */
            background: linear-gradient(135deg, #F8FAFC 0%, #F0F4F8 100%);
            color: #334155; /* Dark gray for main text */
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: 2.5rem;
            padding-bottom: 2.5rem;
        }
        h1, h2, h3 {
            font-family: 'Oxanium', sans-serif;
            color: #1F2937; /* Very dark gray for strong headings */
        }
        h1 {
            text-shadow: 2px 2px 5px rgba(0,0,0,0.1); /* Soft shadow for readability */
        }
        h2 {
            color: #1F2937; /* Main section headings */
        }

        /* Keyframe Animations */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes slideInLeft {
            from { opacity: 0; transform: translateX(-50px); }
            to { opacity: 1; transform: translateX(0); }
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Applying Animations */
        .animate-fade-in { animation: fadeIn 0.8s ease-out forwards; }
        .animate-fade-in-up { animation: fadeInUp 0.7s ease-out forwards; }
        .animate-slide-in-left { animation: slideInLeft 0.9s ease-out forwards; }
        .loading-animation {
            border: 4px solid rgba(150, 150, 150, 0.3);
            border-top: 4px solid #60A5FA; /* Soft blue */
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1.2s cubic-bezier(0.68, -0.55, 0.27, 1.55) infinite;
        }

        /* Base element styling for clean feel */
        .card-base {
            background-color: #FFFFFF; /* Pure white background */
            border: 1px solid #E2E8F0; /* Very light subtle border */
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08); /* Soft, diffused shadow */
            border-radius: 1rem; /* Generously rounded corners */
            padding: 3rem; /* More generous padding */
            transition: all 0.3s ease-in-out;
        }
        .card-base:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15); /* More pronounced shadow on hover */
        }

        /* Header specific styles */
        header {
            background: #FFFFFF; /* Pure white header */
            border-bottom: 2px solid #D1D8E0; /* Subtle divider line */
            box-shadow: 0 3px 10px rgba(0,0,0,0.05); /* Lighter shadow */
        }
        h1 {
            color: #1F2937; /* Dark text for title */
        }

        /* Button styles */
        .modern-btn {
            background: linear-gradient(45deg, #60A5FA, #3B82F6); /* Soft blue gradient */
            color: #FFF;
            font-weight: 600;
            padding: 0.9rem 2.2rem;
            border-radius: 0.75rem; /* More rounded */
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2); /* Soft shadow */
            transition: all 0.3s ease-in-out;
            border: none;
            cursor: pointer;
            background-size: 200% auto;
            position: relative; /* For pseudo-element glow */
            overflow: hidden;
            z-index: 1;
        }
        .modern-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.1); /* Subtle internal light shimmer */
            transform: scaleX(0);
            transform-origin: left;
            transition: transform 0.4s ease-out;
            z-index: -1;
        }
        .modern-btn:hover::before {
            transform: scaleX(1);
        }
        .modern-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 18px rgba(0, 0, 0, 0.3); /* Lifted shadow */
            background-position: right center; /* Gradient shift */
        }
        .modern-btn:disabled {
            background: #CBD5E1;
            color: #64748B;
            box-shadow: none;
            cursor: not-allowed;
            opacity: 0.7;
            transform: none;
        }

        /* Form input styles (if any, typically less in registered.html) */
        input[type="text"], input[type="email"], input[type="password"], input[type="number"], textarea, select {
            background-color: #F8FAFC; /* Light input background */
            border: 1px solid #CBD5E1; /* Subtle border */
            color: #334155;
            border-radius: 0.6rem;
            padding: 0.8rem 1.2rem;
            transition: all 0.2s ease-in-out;
        }
        input[type="text"]::placeholder, input[type="email"]::placeholder, input[type="password"]::placeholder, textarea::placeholder, select::placeholder {
            color: #94A3B8; /* Muted placeholder text */
        }
        input[type="text"]:focus, input[type="email"]:focus, input[type="password"]:focus, input[type="number"]:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #60A5FA; /* Soft blue focus glow */
            box-shadow: 0 0 10px rgba(96, 165, 250, 0.4);
        }
        
        /* Table styles */
        table {
            background-color: #FFFFFF; /* Pure white table background */
            border-radius: 1rem;
            overflow: hidden; /* Ensures rounded corners on table */
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08); /* Soft shadow for tables */
        }
        th {
            background: #E2E8F0; /* Light gray header background */
            color: #475569; /* Darker gray for headers */
            font-weight: 600;
            padding: 1.2rem 1.5rem; /* More padding */
        }
        td {
            border-bottom: 1px solid #E2E8F0; /* Very light border */
            color: #475569; /* Standard text color */
            padding: 1rem 1.5rem;
        }
        tbody tr:last-child td {
            border-bottom: none;
        }
        tbody tr:hover {
            background-color: #F0F4F8; /* Subtle light gray hover effect */
        }

        /* Section specific styles - subtle color variations */
        .section-light-blue-tint { 
            background-color: #F8FAFC; 
            border-left: 5px solid #A5D6F9; /* Very light blue accent */
        }
        .section-light-green-tint {
            background-color: #F8FAFC;
            border-left: 5px solid #81C784; /* Very light green accent */
        }
        .section-light-orange-tint {
            background-color: #F8FAFC;
            border-left: 5px solid #FFCC80; /* Very light orange accent */
        }

        /* Markdown content area background for readability */
        .markdown-content-area {
            background-color: #F0F4F8; /* Slightly darker than main body for contrast */
            border: 1px solid #D1D8E0;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.05); /* Inner shadow */
        }

        /* Custom Modal Styling - Adapting to theme */
        .custom-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.4); /* Semi-transparent dark overlay */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-out, visibility 0.3s ease-out;
        }
        .custom-modal.flex {
            opacity: 1;
            visibility: visible;
        }
        .custom-modal-content {
            background-color: #FFFFFF; /* White modal background */
            color: #334155;
            border: 1px solid #D1D8E0; /* Subtle border */
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.25); /* Stronger, softer shadow */
            border-radius: 1rem;
            padding: 2.5rem;
            position: relative;
            transform: translateY(20px); /* Initial subtle drop-in */
            transition: transform 0.3s ease-out;
        }
        .custom-modal.flex .custom-modal-content {
            transform: translateY(0); /* Animate to original position */
        }
        .custom-modal-close-button {
            color: #64748B; /* Muted gray for close button */
            font-size: 2rem;
            font-weight: 300; /* Lighter weight */
            cursor: pointer;
            transition: color 0.2s ease-in-out;
        }
        .custom-modal-close-button:hover {
            color: #EF4444; /* Soft red on hover */
        }
        .custom-modal .btn-primary-modal {
            background: linear-gradient(45deg, #60A5FA, #3B82F6);
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.15);
            color: #FFF;
            font-weight: 600;
            padding: 0.75rem 1.75rem;
            border-radius: 0.6rem;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .custom-modal .btn-primary-modal:hover {
            box-shadow: 0 5px 12px rgba(0, 0, 0, 0.25);
            transform: translateY(-1px);
        }
        .custom-modal .btn-secondary-modal {
            background-color: #E2E8F0;
            color: #475569;
            border: 1px solid #CBD5E1;
            font-weight: 500;
            padding: 0.75rem 1.75rem;
            border-radius: 0.6rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .custom-modal .btn-secondary-modal:hover {
            background-color: #D1D8E0;
            color: #334155;
        }

        /* Icon Colors - Adjusted for the lighter theme */
        .text-teal-600 { /* For registered.html specific emphasis */
            color: #10B981; /* Emerald Green */
        }
        .text-blue-400 {
            color: #3B82F6; /* Link blue */
        }
        /* Specific style for participant list modal to make it scrollable */
        #participantsListContainer {
            max-height: 400px; /* Adjust as needed */
            overflow-y: auto;
            border: 1px solid #D1D8E0; /* Subtle border */
            border-radius: 0.75rem;
            padding: 1rem;
            margin-top: 1.5rem;
            text-align: left; /* Align text within the list */
            background-color: #F0F4F8; /* Light background for list */
        }
        #participantsListContainer ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        #participantsListContainer li {
            padding: 0.75rem 0;
            border-bottom: 1px dashed #E2E8F0; /* Very subtle dashed line */
        }
        #participantsListContainer li:last-child {
            border-bottom: none;
        }
        #participantsListContainer .slot-number {
            font-weight: bold;
            color: #3B82F6; /* Blue for slot number */
        }
        /* Status colors for registrations table */
        .status-completed { 
            color: #10B981; /* Emerald Green */
            font-weight: 600;
        }
        .status-canceled { 
            color: #EF4444; /* Red */
            font-weight: 600;
        }
        .status-active { 
            color: #3B82F6; /* Blue */
            font-weight: 600;
        }
        /* Button color overrides for this page */
        .modern-btn.\!bg-orange-600 {
            background: linear-gradient(45deg, #FB923C, #EA580C); /* Orange */
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
        }
        .modern-btn.\!bg-orange-600:hover {
            box-shadow: 0 8px 18px rgba(0,0,0,0.25);
        }
        .modern-btn.\!bg-red-600 {
            background: linear-gradient(45deg, #F87171, #EF4444); /* Red */
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
        }
        .modern-btn.\!bg-red-600:hover {
            box-shadow: 0 8px 18px rgba(0,0,0,0.25);
        }
        .modern-btn.\!bg-blue-600 {
            background: linear-gradient(45deg, #60A5FA, #3B82F6); /* Blue */
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
        }
        .modern-btn.\!bg-blue-600:hover {
            box-shadow: 0 8px 18px rgba(0,0,0,0.25);
        }
        .modern-btn.\!bg-teal-700 {
            background: linear-gradient(45deg, #10B981, #059669); /* Teal Green */
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
        }
        .modern-btn.\!bg-teal-700:hover {
            box-shadow: 0 8px 18px rgba(0,0,0,0.25);
        }
        .modern-btn.\!bg-purple-600 {
            background: linear-gradient(45deg, #8B5CF6, #6D28D9); /* Purple */
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
        }
        .modern-btn.\!bg-purple-600:hover {
            box-shadow: 0 8px 18px rgba(0,0,0,0.25);
        }
        .modern-btn.\!bg-gray-700 {
            background: #94A3B8; /* Slate gray for secondary action */
            box-shadow: 0 3px 8px rgba(0,0,0,0.1);
        }
        .modern-btn.\!bg-gray-700:hover {
            background: #64748B;
            box-shadow: 0 5px 12px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body class="py-8 px-4">

    <!-- Loading Screen -->
    <div id="loadingScreen" class="fixed inset-0 flex items-center justify-center bg-gray-100 z-50">
        <div class="flex flex-col items-center">
            <div class="loading-animation"></div>
            <p class="mt-4 text-xl font-semibold text-gray-700">Loading My Registrations...</p>
        </div>
    </div>

    <!-- Main Content -->
    <div id="mainContent" class="hidden card-base max-w-7xl w-full flex flex-col items-center">

        <!-- Header -->
        <header class="text-center mb-12 w-full p-8 card-base shadow-lg animate-fade-in">
            <h1 class="text-5xl lg:text-6xl font-extrabold mb-4 animate-slide-in-left">
                My Registrations üìã
            </h1>
            <p class="text-xl lg:text-2xl text-cyan-300 font-semibold mb-8 animate-fade-in">View and manage your tournament entries.</p>
            
            <div class="border-b-4 border-gray-200 mt-8 mb-6"></div>

            <div class="flex flex-col sm:flex-row justify-between items-center mt-4 space-y-4 sm:space-y-0 text-gray-700">
                <span class="text-md sm:text-lg font-medium text-center sm:text-left">
                    Logged in as: <span class="font-bold text-red-700" id="loggedInEmail">Guest</span> (ID: <span class="font-bold text-red-700 break-all" id="loggedInUserId">N/A</span>)
                </span>
                <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-4 w-full sm:w-auto items-center sm:items-stretch">
                    <a href="/" class="modern-btn !bg-purple-600 hover:!bg-purple-600 w-full sm:w-auto">
                        <i class="fas fa-home mr-2"></i>Go to Home
                    </a>
                    <button id="logoutButton" class="hidden modern-btn !bg-red-500 hover:!bg-red-500 w-full sm:w-auto">
                        <i class="fas fa-sign-out-alt mr-2"></i>Logout
                    </button>
                </div>
            </div>
        </header>

        <!-- Registrations Table -->
        <section class="w-full mb-12 card-base section-light-green-tint animate-fade-in-up">
            <h2 class="text-3xl lg:text-4xl font-bold mb-8 text-center flex items-center justify-center">
                <i class="fas fa-list-alt text-teal-600 mr-3"></i>Your Tournament Entries
            </h2><br> 
            <div style="font-family: Arial, sans-serif; font-size: 16px; line-height: 1.6; background-color: #f9f9f9; padding: 20px; border-radius: 10px; color: #333;">

  <p>üéÆ You have successfully registered for the selected tournament.</p>
  <p>üí∞ <strong>Now please proceed to make the payment.</strong></p>
  <p>üì• <strong>UPI ID:</strong> <span style="color: green;">raj.n@fam</span> ‚úÖ</p>
  <p>üì∏ Once done, send the <strong>payment screenshot</strong> on WhatsApp.</p>
  <p>üìû <strong>WhatsApp Number:</strong> <a href="https://wa.me/919204465448" style="color: #007bff; text-decoration: none;">9204465448</a></p>
  <p>üì¢ Make sure to send the screenshot immediately to confirm your slot.</p>
  <p style="color: red; font-weight: bold;">‚ö†Ô∏è Important: If you do not make the payment or fail to send the screenshot, your slot will NOT be confirmed. No payment = No slot.</p>
  <p>üö´ <strong>Note:</strong> Don‚Äôt pay to any other UPI. Only use <span style="color: green;">raj.n@fam</span>.</p>
  <p>üïπÔ∏è <em>Get ready to battle. Good luck!</em></p>
</div>

            <button onclick="fetchUserRegistrations()" class="mb-6 modern-btn !bg-teal-700 hover:!bg-teal-700">
                Refresh My Registrations <i class="fas fa-sync-alt ml-2"></i>
            </button>
            <div class="overflow-x-auto">
                <table class="min-w-full rounded-lg shadow-sm">
                    <thead>
                        <tr class="uppercase text-sm leading-normal">
                            <th class="py-4 px-6 text-left rounded-tl-lg">Match Type</th>
                            <th class="py-4 px-6 text-left">Match Time</th>
                            <th class="py-4 px-6 text-left">Slot</th>
                            <th class="py-4 px-6 text-left">IGL IGN / FFID</th>
                            <th class="py-4 px-6 text-left">Teammates</th>
                            <th class="py-4 px-6 text-left">Status</th>
                            <th class="py-4 px-6 text-left">Room Code</th>
                            <th class="py-4 px-6 text-left">Room Pass</th>
                            <th class="py-4 px-6 text-center rounded-tr-lg">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="registrationsTableBody" class="text-base font-light">
                        <tr>
                            <td colspan="9" class="py-6 text-center text-gray-600" id="noRegistrationsMessage">
                                You have no registrations.
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>

    </div>

    <!-- Custom Modal for Messages and Confirmations (same as other pages) -->
    <div id="customModal" class="custom-modal">
        <div class="custom-modal-content w-full max-w-md mx-auto">
            <span class="custom-modal-close-button" onclick="closeModal()">&times;</span>
            <div id="modalContent" class="py-6 px-4 sm:px-6">
                <!-- Message will be inserted here -->
            </div>
            <div id="modalButtons" class="mt-8 flex justify-center space-x-4">
                <button id="modalConfirmBtn" class="hidden btn-primary-modal">
                    Confirm
                </button>
                <button id="modalCancelBtn" class="hidden btn-secondary-modal" onclick="closeModal()">
                    Cancel
                </button>
                <button id="modalOkBtn" class="btn-primary-modal" onclick="closeModal()">
                    OK
                </button>
            </div>
        </div>
    </div>

<!-- Firebase SDK (ES Module version) -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    const BACKEND_URL = "https://tha-tournaments.onrender.com";

    const firebaseConfig = {
        apiKey: "AIzaSyD48ch2_ZWn2XPuV-G6wU4Wm3BI1YVGASw",
        authDomain: "tournaments-a652c.firebaseapp.com",
        projectId: "tournaments-a652c",
        storageBucket: "tournaments-a652c.appspot.com",
        messagingSenderId: "989795533335",
        appId: "1:989795533335:web:b45cb8f8c7853b7f1e5252",
        measurementId: "G-M3XGTFTQ4G"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    let currentUser = null;

    // --- Modal Functions ---
    window.openModal = (messageHtml, type = 'ok') => {
        return new Promise((resolve) => {
            const modalContentEl = document.getElementById('modalContent');
            const customModalEl = document.getElementById('customModal');
            const modalOkBtn = document.getElementById('modalOkBtn');
            const modalConfirmBtn = document.getElementById('modalConfirmBtn');
            const modalCancelBtn = document.getElementById('modalCancelBtn');

            if (!modalContentEl || !customModalEl || !modalOkBtn || !modalConfirmBtn || !modalCancelBtn) {
                console.error("Modal elements not found");
                resolve(false);
                return;
            }

            modalContentEl.innerHTML = `<p class="text-xl font-semibold text-gray-700">${messageHtml}</p>`;

            modalOkBtn.classList.add('hidden');
            modalConfirmBtn.classList.add('hidden');
            modalCancelBtn.classList.add('hidden');

            if (type === 'confirm_cancel') {
                modalConfirmBtn.classList.remove('hidden');
                modalCancelBtn.classList.remove('hidden');
                modalConfirmBtn.onclick = () => { closeModal(); resolve(true); };
                modalCancelBtn.onclick = () => { closeModal(); resolve(false); };
            } else {
                modalOkBtn.classList.remove('hidden');
                modalOkBtn.onclick = () => { closeModal(); resolve(true); };
            }

            customModalEl.classList.add('flex');
        });
    };

    window.closeModal = () => {
        const customModalEl = document.getElementById('customModal');
        if (customModalEl) customModalEl.classList.remove('flex');
    };

    window.fetchUserRegistrations = async () => {
        const registrationsTableBody = document.getElementById('registrationsTableBody');
        if (!registrationsTableBody) return;

        registrationsTableBody.innerHTML = `<tr><td colspan="9" class="py-6 text-center text-gray-600">Loading your registrations...</td></tr>`;

        if (!currentUser) {
            registrationsTableBody.innerHTML = `
                <tr>
                    <td colspan="9" class="py-6 text-center text-red-500 font-semibold">
                        You must be logged in to view registrations. 
                        <a href="/" class="text-blue-400 hover:underline">Go to Home</a>
                    </td>
                </tr>
            `;
            return;
        }

        try {
            const response = await fetch(`${BACKEND_URL}/api/get_registrations?userId=${currentUser.uid}`);
            const result = await response.json();

            if (result.success && result.registrations.length > 0) {
                registrationsTableBody.innerHTML = '';

                result.registrations.forEach(reg => {
                    const teammatesHtml = reg.teammates && reg.teammates.length > 0
                        ? reg.teammates.map(t => `${t.ign || 'N/A'} (${t.ffid || 'N/A'})`).join('<br>')
                        : 'N/A';

                    let displayStatus = (reg.status || 'unknown').toUpperCase();
                    let statusClass = 'text-gray-400';

                    if (reg.isCompleted) {
                        displayStatus = 'COMPLETED';
                        statusClass = 'status-completed';
                    } else if (reg.status === 'canceled') {
                        displayStatus = 'CANCELED';
                        statusClass = 'status-canceled';
                    } else if (reg.status === 'registered') {
                        displayStatus = 'ACTIVE';
                        statusClass = 'status-active';
                    }

                    const row = `
                        <tr class="border-b border-gray-200 hover:bg-gray-50">
                            <td class="py-4 px-6 text-left">${reg.matchType}</td>
                            <td class="py-4 px-6 text-left">${reg.matchTime}</td>
                            <td class="py-4 px-6 text-left font-bold text-lg">${reg.slotNumber || 'N/A'}</td>
                            <td class="py-4 px-6 text-left">${reg.iglIGN || 'N/A'} / ${reg.iglFFID || 'N/A'}</td>
                            <td class="py-4 px-6 text-left text-sm">${teammatesHtml}</td>
                            <td class="py-4 px-6 text-left font-semibold ${statusClass}">${displayStatus}</td>
                            <td class="py-4 px-6 text-left">${reg.roomCode || 'Not Available'}</td>
                            <td class="py-4 px-6 text-left">${reg.roomPassword || 'Not Available'}</td>
                            <td class="py-4 px-6 text-center whitespace-nowrap">
                                <button onclick="viewMatchParticipants('${reg.matchId}')" class="modern-btn !bg-blue-600 hover:!bg-blue-600 text-xs mb-1 py-2 px-4">
                                    <i class="fas fa-users mr-1"></i> Participants
                                </button>
                                <button onclick="cancelRegistration('${reg.id}', '${reg.userId}')" class="modern-btn !bg-orange-600 hover:!bg-orange-600 text-xs mr-2 py-2 px-4" ${reg.status === 'canceled' || reg.isCompleted ? 'disabled' : ''}>
                                    <i class="fas fa-times-circle mr-1"></i> Cancel
                                </button>
                                <button onclick="deleteRegistration('${reg.id}', '${reg.userId}')" class="modern-btn !bg-red-600 hover:!bg-red-600 text-xs py-2 px-4">
                                    <i class="fas fa-trash mr-1"></i> Delete
                                </button>
                            </td>
                        </tr>
                    `;
                    registrationsTableBody.insertAdjacentHTML('beforeend', row);
                });
            } else {
                registrationsTableBody.innerHTML = `
                    <tr>
                        <td colspan="9" class="py-6 text-center text-gray-600">
                            You have no registrations
                        </td>
                    </tr>
                `;
            }
        } catch (error) {
            console.error("Fetch error:", error);
            registrationsTableBody.innerHTML = `
                <tr>
                    <td colspan="9" class="py-6 text-center text-red-500">
                        Error loading data. Please try again later.
                    </td>
                </tr>
            `;
            await openModal("Failed to load registrations. Please check your connection.");
        }
    };

    window.viewMatchParticipants = async (matchId) => {
        if (!matchId) return;

        await openModal('<p class="text-center">Loading participants...</p>');

        try {
            const response = await fetch(`${BACKEND_URL}/api/get_match_participants?matchId=${matchId}`);
            const result = await response.json();

            let content = `<h3 class="text-xl font-bold mb-4">Match ID: ${matchId}</h3>`;

            if (result.success && result.participants.length > 0) {
                content += `<div class="max-h-96 overflow-y-auto"><ul class="space-y-3">`;
                result.participants.forEach(p => {
                    content += `<li class="border-b pb-2">
                        <span class="font-bold">Slot ${p.slotNumber}:</span> 
                        ${p.iglIGN} (${p.iglFFID})
                        ${p.teammates?.length ? `<ul class="ml-5 mt-1 text-sm text-gray-600">${p.teammates.map(t => `<li>${t.ign} (${t.ffid})</li>`).join('')}</ul>` : ''}
                    </li>`;
                });
                content += `</ul></div>`;
            } else {
                content += `<p>No participants found</p>`;
            }

            closeModal();
            await openModal(content);
        } catch (error) {
            console.error("Participants error:", error);
            closeModal();
            await openModal("Failed to load participants");
        }
    };

    window.cancelRegistration = async (registrationId, userId) => {
        const confirmed = await openModal('Cancel this registration? This cannot be undone.', 'confirm_cancel');
        if (!confirmed) return;

        try {
            const response = await fetch(`${BACKEND_URL}/api/update_registration_status`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    registrationId, 
                    userId, 
                    status: 'canceled' 
                }),
            });

            const result = await response.json();
            await openModal(result.message || (result.success ? "Registration canceled" : "Operation failed"));
            if (result.success) fetchUserRegistrations();
        } catch (error) {
            console.error("Cancel error:", error);
            await openModal("Failed to cancel registration");
        }
    };

    window.deleteRegistration = async (registrationId, userId) => {
        const confirmed = await openModal('Permanently delete this registration? This cannot be undone.', 'confirm_cancel');
        if (!confirmed) return;

        try {
            const response = await fetch(`${BACKEND_URL}/api/delete_registration`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ registrationId, userId }),
            });

            const result = await response.json();
            await openModal(result.message || (result.success ? "Registration deleted" : "Delete failed"));
            if (result.success) fetchUserRegistrations();
        } catch (error) {
            console.error("Delete error:", error);
            await openModal("Failed to delete registration");
        }
    };

    onAuthStateChanged(auth, (user) => {
        const loadingScreen = document.getElementById('loadingScreen');
        const mainContent = document.getElementById('mainContent');
        const loggedInEmailSpan = document.getElementById('loggedInEmail');
        const loggedInUserIdSpan = document.getElementById('loggedInUserId');
        const logoutButton = document.getElementById('logoutButton');

        if (loadingScreen) loadingScreen.classList.add('hidden');
        if (mainContent) mainContent.classList.remove('hidden');

        currentUser = user;

        if (user) {
            if (loggedInEmailSpan) loggedInEmailSpan.textContent = user.email;
            if (loggedInUserIdSpan) loggedInUserIdSpan.textContent = user.uid;
            if (logoutButton) logoutButton.classList.remove('hidden');

            logoutButton.onclick = async () => {
                try {
                    await signOut(auth);
                    window.location.href = '/';
                } catch (error) {
                    console.error("Logout error:", error);
                    await openModal("Logout failed");
                }
            };

            fetchUserRegistrations();
        } else {
            if (loggedInEmailSpan) loggedInEmailSpan.textContent = 'Guest';
            if (loggedInUserIdSpan) loggedInUserIdSpan.textContent = 'N/A';
            if (logoutButton) logoutButton.classList.add('hidden');

            const registrationsTableBody = document.getElementById('registrationsTableBody');
            if (registrationsTableBody) {
                registrationsTableBody.innerHTML = `
                    <tr>
                        <td colspan="9" class="py-6 text-center text-red-500 font-semibold">
                            Please <a href="/" class="text-blue-400 hover:underline">login</a> to view registrations
                        </td>
                    </tr>
                `;
            }
        }
    });
</script>

</body>
</html>
