<!DOCTYPE html>
<html lang="en">
<head>
    <base href="/" />
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wallet - THA Tournaments</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Razorpay Checkout Script -->
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <style>
        /* Reuse existing styles from index.html */
        @import url('https://fonts.googleapis.com/css2?family=Oxanium:wght@500;700&family=Inter:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background: transparent;
            color: #334155;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: 2.5rem;
            padding-bottom: 2.5rem;
        }
        
        #background-video {
            position: fixed;
            right: 0;
            bottom: 0;
            min-width: 100%;
            min-height: 100%;
            width: auto;
            height: auto;
            z-index: -100;
            background-size: cover;
            filter: brightness(0.6); /* Increased brightness for better visibility */
        }

        /* Custom button styles */
        .modern-btn {
            background: linear-gradient(145deg, #60A5FA, #3B82F6);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border: none;
            cursor: pointer;
        }

        .modern-btn:hover {
            background: linear-gradient(145deg, #3B82F6, #60A5FA);
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
            transform: translateY(-2px);
        }

        .modern-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        /* Card styles */
        .card {
            background-color: #ffffff;
            border-radius: 1rem;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.08);
            padding: 2rem;
            margin-bottom: 1.5rem;
            width: 100%;
        }

        /* Input focus styles */
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #3B82F6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }

        /* Loading animation for modal */
        .loading-animation {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #3B82F6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center justify-center p-4 relative">
    <!-- Background Video -->
    <video autoplay muted loop id="background-video">
        <source src="https://assets.mixkit.co/videos/preview/mixkit-fire-burning-in-the-dark-2775-large.mp4" type="video/mp4">
        Your browser does not support the video tag.
    </video>

    <!-- Loading Screen -->
    <div id="loadingScreen" class="fixed inset-0 bg-gray-900 bg-opacity-90 flex items-center justify-center z-50">
        <div class="text-center text-white">
            <div class="loading-animation mx-auto mb-4"></div>
            <p class="text-xl font-semibold">Loading Wallet...</p>
        </div>
    </div>

    <!-- Main Content -->
    <div id="mainContent" class="hidden w-full max-w-4xl bg-white rounded-xl shadow-2xl p-8 relative z-10">
        <header class="flex justify-between items-center mb-8 pb-4 border-b border-gray-200">
            <h1 class="text-4xl font-extrabold text-gray-800 tracking-tight">
                <i class="fas fa-wallet text-blue-500 mr-3"></i>My Wallet
            </h1>
            <button id="logoutButton" class="modern-btn bg-red-500 hover:bg-red-600 px-4 py-2 text-sm">
                <i class="fas fa-sign-out-alt mr-2"></i>Logout
            </button>
        </header>

        <!-- Wallet Balance Section -->
        <section class="card bg-gradient-to-r from-blue-500 to-indigo-600 text-white p-6 mb-8 transform hover:scale-105 transition-transform duration-300">
            <h2 class="text-2xl font-bold mb-2 flex items-center">
                <i class="fas fa-coins mr-3"></i>Current Balance
            </h2>
            <p class="text-5xl font-extrabold tracking-wide">
                ₹<span id="walletBalance">0.00</span>
            </p>
            <p class="mt-4 text-sm opacity-90">Funds can be used for tournament registrations.</p>
        </section>

        <!-- Add Funds Section -->
        <section class="card">
            <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">
                <i class="fas fa-plus-circle text-green-500 mr-3"></i>Add Funds
            </h2>
            <div class="flex flex-col sm:flex-row gap-4 items-end">
                <div class="flex-grow w-full">
                    <label for="addAmount" class="block text-gray-700 text-sm font-medium mb-2">Amount (₹)</label>
                    <input type="number" id="addAmount" placeholder="e.g., 100" min="1" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-400 focus:border-transparent transition duration-200">
                </div>
                <button id="addFundsButton" class="modern-btn w-full sm:w-auto">
                    <i class="fas fa-money-bill-wave mr-2"></i>Proceed to Payment
                </button>
            </div>
        </section>

        <!-- Transaction History Section -->
        <section class="card mt-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">
                <i class="fas fa-history text-purple-500 mr-3"></i>Transaction History
            </h2>
            <div class="overflow-x-auto rounded-lg shadow-sm border border-gray-200">
                <table class="min-w-full bg-white">
                    <thead class="bg-gray-50 border-b border-gray-200">
                        <tr>
                            <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                            <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                            <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Amount</th>
                            <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">New Balance</th>
                            <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Description</th>
                        </tr>
                    </thead>
                    <tbody id="transactionsTableBody" class="divide-y divide-gray-100">
                        <!-- Transactions will be loaded here by JavaScript -->
                        <tr>
                            <td colspan="5" class="py-4 text-center text-gray-500">Loading transactions...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>
    </div>

    <!-- Payment Processing Modal -->
    <div id="paymentProcessingModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-8 rounded-lg shadow-xl text-center flex flex-col items-center">
            <div class="loading-animation mb-4"></div>
            <p class="text-xl font-semibold text-gray-800">Processing Payment...</p>
            <p class="text-gray-600">Please wait while we process your transaction.</p>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

        // Your Firebase configuration (ensure this is correct)
        const firebaseConfig = {
            apiKey: "AIzaSyD48ch2_ZWn2XPuV-G6wU4Wm3BI1YVGASw", // Replace with your actual Firebase API Key
            authDomain: "tournaments-a652c.firebaseapp.com",
            projectId: "tournaments-a652c",
            storageBucket: "tournaments-a652c.appspot.com",
            messagingSenderId: "989795533335",
            appId: "1:989795533335:web:b45cb8f8c7853b7f1e5252"
			measurementId: "G-M3XGTFTQ4G"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        let currentUser = null;

        const API_BASE_URL = window.location.origin; // Dynamically get the base URL
        const paymentProcessingModal = document.getElementById('paymentProcessingModal');

        // Function to show/hide the payment processing modal
        function togglePaymentProcessingModal(show) {
            if (show) {
                paymentProcessingModal.classList.remove('hidden');
            } else {
                paymentProcessingModal.classList.add('hidden');
            }
        }

        // Function to display custom modal messages
        async function openModal(message, type = 'alert') {
            return new Promise((resolve) => {
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50';
                modal.innerHTML = `
                    <div class="bg-white p-6 rounded-lg shadow-xl text-center max-w-sm mx-auto">
                        <p class="text-lg font-semibold mb-4">${message}</p>
                        <button id="modalConfirmBtn" class="modern-btn px-6 py-2">OK</button>
                    </div>
                `;
                document.body.appendChild(modal);

                document.getElementById('modalConfirmBtn').onclick = () => {
                    document.body.removeChild(modal);
                    resolve();
                };
            });
        }

        // New: Fetch and display wallet balance
        async function updateWalletBalance() {
            if (!currentUser) return;
            try {
                const response = await fetch(`${API_BASE_URL}/api/wallet?userId=${currentUser.uid}`);
                const result = await response.json();
                
                if (result.success) {
                    document.getElementById('walletBalance').textContent = result.balance.toFixed(2);
                } else {
                    await openModal(`Error fetching wallet balance: ${result.message}`);
                }
            } catch (error) {
                console.error('Failed to update wallet balance:', error);
                await openModal('Failed to connect to wallet service.');
            }
        }

        // New: Fetch and display transaction history
        async function fetchTransactions() {
            if (!currentUser) return;
            try {
                const response = await fetch(`${API_BASE_URL}/api/wallet/transactions?userId=${currentUser.uid}`);
                const result = await response.json();

                const transactionsTableBody = document.getElementById('transactionsTableBody');
                transactionsTableBody.innerHTML = ''; // Clear previous transactions

                if (result.success && result.transactions.length > 0) {
                    result.transactions.forEach(transaction => {
                        const row = document.createElement('tr');
                        let statusClass = '';
                        let typeText = '';
                        if (transaction.type === 'credit') {
                            statusClass = 'text-green-600';
                            typeText = 'Credit';
                        } else if (transaction.type === 'debit') {
                            statusClass = 'text-red-600';
                            typeText = 'Debit';
                        }

                        row.innerHTML = `
                            <td class="py-3 px-4">${transaction.timestamp}</td>
                            <td class="py-3 px-4 ${statusClass}">${typeText}</td>
                            <td class="py-3 px-4">₹${transaction.amount.toFixed(2)}</td>
                            <td class="py-3 px-4">₹${transaction.newBalance.toFixed(2)}</td>
                            <td class="py-3 px-4 text-sm text-gray-500">${transaction.description || 'N/A'}</td>
                        `;
                        transactionsTableBody.appendChild(row);
                    });
                } else {
                    transactionsTableBody.innerHTML = `<tr><td colspan="5" class="py-4 text-center text-gray-500">No transactions found.</td></tr>`;
                }
            } catch (error) {
                console.error('Failed to fetch transactions:', error);
                await openModal('Failed to fetch transaction history.');
            }
        }

        // Function to initiate Razorpay payment
        async function initiateRazorpayPayment(order) {
            const options = {
                key: order.key_id, // Your Razorpay Key ID
                amount: order.amount, // Amount in paise
                currency: order.currency,
                name: "THA Tournaments",
                description: "Add funds to wallet",
                order_id: order.id,
                handler: async function (response) {
                    togglePaymentProcessingModal(true); // Show processing modal
                    try {
                        const verificationResponse = await fetch(`${API_BASE_URL}/api/verify-razorpay-payment`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                razorpay_order_id: response.razorpay_order_id,
                                razorpay_payment_id: response.razorpay_payment_id,
                                razorpay_signature: response.razorpay_signature,
                                userId: currentUser.uid,
                                amount: parseFloat(order.amount) / 100 // Send original amount for backend logic
                            })
                        });
                        const verificationResult = await verificationResponse.json();

                        if (verificationResult.success) {
                            await openModal("Funds added successfully!", "success");
                            updateWalletBalance(); // Refresh balance
                            fetchTransactions(); // Refresh transactions
                        } else {
                            await openModal(`Payment verification failed: ${verificationResult.message}`, "error");
                        }
                    } catch (error) {
                        console.error('Error during payment verification:', error);
                        await openModal("An error occurred during payment verification. Please contact support.", "error");
                    } finally {
                        togglePaymentProcessingModal(false); // Hide processing modal
                    }
                },
                prefill: {
                    name: currentUser.displayName || "",
                    email: currentUser.email || "",
                    contact: "" // Optional: user's phone number
                },
                notes: {
                    userId: currentUser.uid,
                    purpose: "wallet_recharge"
                },
                theme: {
                    color: "#3B82F6"
                }
            };

            const rzp1 = new Razorpay(options);
            rzp1.on('payment.failed', async function (response) {
                console.error('Payment failed:', response.error);
                togglePaymentProcessingModal(false); // Hide processing modal
                await openModal(`Payment failed: ${response.error.description || 'Unknown error'}. Please try again.`);
                // Redirect back to wallet.html or simply hide the modal
                // For now, we just hide modal and stay on wallet.html
            });
            rzp1.on('payment.cancelled', async function () {
                togglePaymentProcessingModal(false); // Hide processing modal
                await openModal('Payment cancelled by user.').then(() => {
                    // Optional: Redirect or just remain on the page
                    window.location.href = '/wallet.html'; // Redirect to clear any stuck state
                });
            });
            rzp1.open();
        }

        // Function to add funds (called by button click)
        async function addFunds() {
            if (!currentUser) {
                await openModal("Please log in to add funds.");
                return;
            }

            const amountInput = document.getElementById('addAmount');
            const amount = parseFloat(amountInput.value);

            if (isNaN(amount) || amount <= 0) {
                await openModal("Please enter a valid positive amount.");
                return;
            }

            togglePaymentProcessingModal(true); // Show processing modal
            try {
                const response = await fetch(`${API_BASE_URL}/api/create-razorpay-order`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        amount: amount,
                        userId: currentUser.uid,
                        userEmail: currentUser.email,
                        userName: currentUser.displayName
                    })
                });
                const result = await response.json();

                if (result.success) {
                    // Pass the order details and the Razorpay Key ID
                    initiateRazorpayPayment({
                        key_id: "rzp_live_Zlm2mpJcfzPo7c", // !!! IMPORTANT: Replace with your actual public Razorpay Key ID
                        amount: result.order.amount,
                        currency: result.order.currency,
                        id: result.order.id
                    });
                } else {
                    togglePaymentProcessingModal(false); // Hide processing modal
                    await openModal(`Failed to create order: ${result.message}`);
                }
            } catch (error) {
                console.error('Error creating Razorpay order:', error);
                togglePaymentProcessingModal(false); // Hide processing modal
                await openModal("An error occurred while initiating payment. Please try again.");
            }
        }

        // Initial wallet page setup
        async function initWalletPage() {
            await updateWalletBalance();
            await fetchTransactions();
            
            // Show main content
            document.getElementById('loadingScreen').classList.add('hidden');
            document.getElementById('mainContent').classList.remove('hidden');
        }

        // Event Listeners
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('addFundsButton').addEventListener('click', addFunds);
            // Logout Button
            const logoutButton = document.getElementById('logoutButton');
            if (logoutButton) {
                logoutButton.addEventListener('click', async () => {
                    try {
                        await signOut(auth);
                        window.location.href = '/'; // Redirect to home after logout
                    } catch (error) {
                        console.error("Logout error:", error);
                        await openModal("Logout failed");
                    }
                });
            }
        });
        
        // Auth state listener
        onAuthStateChanged(auth, (user) => {
            const loadingScreen = document.getElementById('loadingScreen');
            const mainContent = document.getElementById('mainContent');
            
            if (loadingScreen) loadingScreen.classList.add('hidden');
            if (mainContent) mainContent.classList.remove('hidden');
            
            currentUser = user;
            
            if (user) {
                initWalletPage();
            } else {
                // Redirect to home if not logged in
                window.location.href = '/';
            }
        });
    </script>
</body>
</html>
