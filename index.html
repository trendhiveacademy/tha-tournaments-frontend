<!DOCTYPE html>
<html lang="en">
<head>
    <base href="/" />
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>THA Tournaments</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Custom Fonts from Google Fonts */
        @import url('https://fonts.googleapis.com/css2?family=Oxanium:wght@500;700&family=Inter:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background: transparent;
            color: #334155;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: 2.5rem;
            padding-bottom: 2.5rem;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
        }

        #background-video {
            position: fixed;
            right: 0;
            bottom: 0;
            min-width: 100%;
            min-height: 100%;
            width: auto;
            height: auto;
            z-index: -100;
            object-fit: cover;
            filter: brightness(0.5) contrast(1.2);
        }

        h1, h2, h3 {
            font-family: 'Oxanium', sans-serif;
            color: #FFFFFF;
        }
        h1 {
            text-shadow: 0 0 15px rgba(59, 130, 246, 0.7);
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes slideInLeft {
            from { opacity: 0; transform: translateX(-50px); }
            to { opacity: 1; transform: translateX(0); }
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        @keyframes futuristicGlow {
            0%, 100% {
                box-shadow: 0 0 5px rgba(96, 165, 250, 0.2), 0 0 10px rgba(96, 165, 250, 0.2), 0 0 20px rgba(96, 165, 250, 0.2);
            }
            50% {
                box-shadow: 0 0 10px rgba(96, 165, 250, 0.5), 0 0 20px rgba(96, 165, 250, 0.5), 0 0 40px rgba(96, 165, 250, 0.5);
            }
        }

        .animate-fade-in { animation: fadeIn 0.8s ease-out forwards; }
        .animate-fade-in-up { animation: fadeInUp 0.7s ease-out forwards; }
        .animate-slide-in-left { animation: slideInLeft 0.9s ease-out forwards; }
        .loading-animation {
            border: 4px solid rgba(150, 150, 150, 0.3);
            border-top: 4px solid #60A5FA;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1.2s cubic-bezier(0.68, -0.55, 0.27, 1.55) infinite;
        }

        .card-base {
            background-color: rgba(30, 41, 59, 0.8);
            border: 1px solid rgba(99, 102, 241, 0.3);
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.3);
            border-radius: 1rem;
            padding: 3rem;
            transition: all 0.3s ease-in-out;
            backdrop-filter: blur(10px);
        }
        .card-base:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(79, 70, 229, 0.4);
        }

        header.card-base {
            background-color: rgba(30, 41, 59, 0.9);
            animation: futuristicGlow 4s ease-in-out infinite;
        }

        .modern-btn {
            background: linear-gradient(45deg, #6366F1, #4F46E5);
            color: #FFF;
            font-weight: 600;
            padding: 0.9rem 2.2rem;
            border-radius: 0.75rem;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.25);
            transition: all 0.3s ease-in-out;
            border: none;
            cursor: pointer;
            background-size: 200% auto;
            position: relative;
            overflow: hidden;
            z-index: 1;
        }
        .modern-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.15);
            transform: scaleX(0);
            transform-origin: left;
            transition: transform 0.4s ease-out;
            z-index: -1;
        }
        .modern-btn:hover::before {
            transform: scaleX(1);
        }
        .modern-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(79, 70, 229, 0.5);
            background-position: right center;
        }
        .modern-btn:disabled {
            background: #475569;
            color: #94a3b8;
            box-shadow: none;
            cursor: not-allowed;
            opacity: 0.7;
            transform: none;
        }

        input[type="text"], input[type="email"], input[type="password"], input[type="number"], textarea, select {
            background-color: rgba(15, 23, 42, 0.7);
            border: 1px solid #334155;
            color: #e2e8f0;
            border-radius: 0.6rem;
            padding: 0.8rem 1.2rem;
            transition: all 0.2s ease-in-out;
            backdrop-filter: blur(5px);
        }
        input[type="text"]::placeholder, input[type="email"]::placeholder, input[type="password"]::placeholder, textarea::placeholder, select::placeholder {
            color: #94a3b8;
        }
        input[type="text"]:focus, input[type="email"]:focus, input[type="password"]:focus, input[type="number"]:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #6366F1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.3);
        }
        
        table {
            background-color: rgba(30, 41, 59, 0.7);
            border-radius: 1rem;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(5px);
            border: 1px solid rgba(99, 102, 241, 0.2);
        }
        th {
            background: rgba(30, 41, 59, 0.9);
            color: #cbd5e1;
            font-weight: 600;
            padding: 1.2rem 1.5rem;
            border-bottom: 1px solid rgba(99, 102, 241, 0.3);
        }
        td {
            border-bottom: 1px solid rgba(51, 65, 85, 0.5);
            color: #e2e8f0;
            padding: 1rem 1.5rem;
        }
        tbody tr:last-child td {
            border-bottom: none;
        }
        tbody tr:hover {
            background-color: rgba(51, 65, 85, 0.4);
        }

        .section-light-blue-tint { 
            background-color: rgba(30, 41, 59, 0.8);
            border-left: 5px solid rgba(59, 130, 246, 0.7);
        }
        .section-light-green-tint {
            background-color: rgba(30, 41, 59, 0.8);
            border-left: 5px solid rgba(16, 185, 129, 0.7);
        }
        .section-light-orange-tint {
            background-color: rgba(30, 41, 59, 0.8);
            border-left: 5px solid rgba(245, 158, 11, 0.7);
        }

        .direct-content-area {
            background-color: rgba(15, 23, 42, 0.7);
            border: 1px solid rgba(51, 65, 85, 0.5);
            box-shadow: inset 0 2px 10px rgba(0,0,0,0.2);
            padding: 2rem;
            border-radius: 0.75rem;
            white-space: pre-wrap;
            line-height: 1.6;
            color: #cbd5e1;
            backdrop-filter: blur(5px);
        }

        .custom-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-out, visibility 0.3s ease-out;
        }
        .custom-modal.flex {
            opacity: 1;
            visibility: visible;
        }
        .custom-modal-content {
            background-color: rgba(30, 41, 59, 0.95);
            color: #e2e8f0;
            border: 1px solid #4F46E5;
            box-shadow: 0 10px 35px rgba(79, 70, 229, 0.3);
            border-radius: 1rem;
            padding: 2.5rem;
            position: relative;
            transform: translateY(20px);
            transition: transform 0.3s ease-out;
            backdrop-filter: blur(15px);
            width: 90%;
            max-width: 500px;
        }
        .custom-modal.flex .custom-modal-content {
            transform: translateY(0);
        }
        .custom-modal-close-button {
            position: absolute;
            top: 15px;
            right: 20px;
            color: #94a3b8;
            font-size: 2rem;
            font-weight: 300;
            cursor: pointer;
            transition: color 0.2s ease-in-out;
        }
        .custom-modal-close-button:hover {
            color: #EF4444;
        }
        .btn-primary-modal {
            background: linear-gradient(45deg, #6366F1, #4F46E5);
            box-shadow: 0 3px 12px rgba(0, 0, 0, 0.2);
            color: #FFF;
            font-weight: 600;
            padding: 0.75rem 1.75rem;
            border-radius: 0.6rem;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .btn-primary-modal:hover {
            box-shadow: 0 5px 18px rgba(79, 70, 229, 0.4);
            transform: translateY(-2px);
        }
        .btn-secondary-modal {
            background-color: #475569;
            color: #e2e8f0;
            border: 1px solid #4F46E5;
            font-weight: 500;
            padding: 0.75rem 1.75rem;
            border-radius: 0.6rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .btn-secondary-modal:hover {
            background-color: #4F46E5;
            color: white;
        }

        .teammate-entry {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        .teammate-entry input {
            flex: 1;
        }
        .remove-teammate-btn {
            background: linear-gradient(45deg, #EF4444, #DC2626) !important;
            width: 42px;
            height: 42px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
        }

        .logo-placeholder {
            width: 100px;
            height: 50px;
            background: linear-gradient(45deg, #6366F1, #4F46E5);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 18px;
        }
    </style>
</head>
<body class="py-8 px-4">
    <!-- Video Background -->
    <video autoplay muted loop id="background-video">
        <source src="https://assets.mixkit.co/videos/preview/mixkit-abstract-digital-waves-54628-large.mp4" type="video/mp4">
    </video>

    <div id="loadingScreen" class="fixed inset-0 flex items-center justify-center bg-gray-900 z-50">
        <div class="flex flex-col items-center">
            <div class="loading-animation"></div>
            <p class="mt-4 text-xl font-semibold text-white">Loading Tournament Site...</p>
        </div>
    </div>

    <div id="mainContent" class="hidden card-base max-w-7xl w-full flex flex-col items-center">

        <header class="text-center mb-12 w-full p-8 card-base shadow-lg animate-fade-in">
            <div class="flex justify-center items-center mb-4">
                <div class="logo-placeholder">THA</div>
                <h1 class="text-5xl lg:text-6xl font-extrabold animate-slide-in-left ml-6">
                    THA Tournaments
                </h1>
            </div>
            <p class="text-xl lg:text-2xl text-cyan-300 font-semibold mb-8 animate-fade-in">Join the ultimate tournament experience!</p>
            
            <div class="border-b-2 border-indigo-500 border-opacity-50 mt-8 mb-6"></div>

            <div class="flex flex-col sm:flex-row justify-between items-center mt-4 space-y-4 sm:space-y-0 text-gray-300">
                <span class="text-md sm:text-lg font-medium text-center sm:text-left">
                    Welcome, <span class="font-bold text-amber-400" id="loggedInEmail">Guest</span>!
                </span>
                <div class="flex flex-wrap justify-center gap-3 w-full sm:w-auto">
                    <button id="authButton" class="modern-btn">
                        <i class="fas fa-sign-in-alt mr-2"></i>Login / Register
                    </button>

                    <a href="/registered.html" id="myRegistrationsButton" class="hidden modern-btn !bg-green-600">
                        <i class="fas fa-clipboard-list mr-2"></i>My Registrations
                    </a>

                    <button id="walletButton" class="modern-btn !bg-purple-600">
                        <i class="fas fa-wallet mr-2"></i>Wallet
                    </button>

                    <button id="logoutButton" class="hidden modern-btn !bg-red-500">
                        <i class="fas fa-sign-out-alt mr-2"></i>Logout
                    </button>
                </div>
            </div>
        </header>

        <section class="w-full mb-12 card-base section-light-blue-tint animate-fade-in-up">
            <h2 class="text-3xl lg:text-4xl font-bold mb-8 text-center flex items-center justify-center">
                <i class="fas fa-calendar-check text-purple-400 mr-3"></i>Current & Upcoming Matches
            </h2>
            <div id="matchesContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                <p class="text-center text-gray-400 md:col-span-3" id="loadingMatchesMessage">Loading matches...</p>
            </div>
            <p id="noMatchesMessage" class="hidden text-center text-gray-400 mt-6">No upcoming matches available for registration.</p>
        </section>

        <section class="w-full mb-12 card-base section-light-green-tint animate-fade-in-up">
            <h2 class="text-3xl lg:text-4xl font-bold mb-8 text-center flex items-center justify-center">
                <i class="fas fa-user-plus text-blue-400 mr-3"></i>Register for a Tournament
            </h2>
            <p id="registrationMessage" class="hidden text-center text-red-400 font-semibold mb-6"></p>
            <form id="registrationForm" class="space-y-6">
                <div id="loggedInUserInfo" class="hidden bg-indigo-900 bg-opacity-50 p-4 rounded-lg text-blue-300 font-medium border border-indigo-500 shadow-sm">
                    Logged in as: <span id="regEmail" class="font-semibold"></span> (ID: <span id="regUserId" class="font-semibold"></span>)
                </div>
                <div id="loginPrompt" class="text-center text-red-400 font-bold hidden text-lg">
                    Please log in or register to participate in tournaments.
                </div>

                <div>
                    <label for="matchSelect" class="block text-gray-300 text-base font-bold mb-2">Select Match Type & Time:</label>
                    <select id="matchSelect" class="w-full py-3 px-4 focus:ring-2 focus:ring-indigo-500" required>
                        <option value="">-- Loading Matches --</option>
                    </select>
                </div>
                <div>
                    <label for="iglIGN" class="block text-gray-300 text-base font-bold mb-2">Your IGN (In-Game Name):</label>
                    <input type="text" id="iglIGN" class="w-full py-3 px-4" placeholder="Your Free Fire IGN" required>
                </div>
                <div>
                    <label for="iglFFID" class="block text-gray-300 text-base font-bold mb-2">Your FFID (Free Fire ID):</label>
                    <input type="text" id="iglFFID" class="w-full py-3 px-4" placeholder="Your 9-10 digit Free Fire ID" required>
                </div>
                <div id="teammatesSection" class="hidden border border-indigo-500 border-opacity-30 p-6 rounded-lg bg-slate-800 bg-opacity-50 shadow-sm">
                    <h3 class="text-xl font-bold text-indigo-300 mb-4">Teammates (for Duo/Squad/Team Matches)</h3>
                    <div id="teammatesList" class="space-y-4">
                        <!-- Teammate inputs will be added here -->
                    </div>
                    <button type="button" id="addTeammateButton" class="mt-5 modern-btn !bg-gray-700">
                        <i class="fas fa-plus-circle mr-1"></i>Add Teammate
                    </button>
                </div>
                <button type="submit" id="registerButton" class="modern-btn w-full mt-6">
                    Register Now! <i class="fas fa-arrow-right ml-2"></i>
                </button>
            </form>
        </section>

        <section class="w-full mb-12 card-base section-light-orange-tint animate-fade-in-up">
            <h2 class="text-3xl lg:text-4xl font-bold mb-8 text-center flex items-center justify-center">
                <i class="fas fa-calendar-days text-indigo-400 mr-3"></i>Full Daily Schedule
            </h2>
            <div class="overflow-x-auto rounded-xl">
                <table class="min-w-full">
                    <thead>
                        <tr class="uppercase text-sm leading-normal">
                            <th class="py-4 px-6 text-left rounded-tl-lg">Time</th>
                            <th class="py-4 px-6 text-left">Event / Description</th>
                            <th class="py-4 px-6 text-left rounded-tr-lg">Notes</th>
                        </tr>
                    </thead>
                    <tbody id="scheduleTableBody" class="text-base font-light">
                        <tr>
                            <td colspan="3" class="py-6 text-center text-gray-400" id="loadingScheduleMessage">Loading schedule...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <p id="noScheduleMessage" class="hidden text-center text-gray-400 mt-6">No schedule items configured yet.</p>
        </section>

        <section class="w-full mb-12 card-base section-light-blue-tint animate-fade-in-up">
            <h2 class="text-3xl lg:text-4xl font-bold mb-8 text-center flex items-center justify-center">
                <i class="fas fa-money-bill-wave text-yellow-400 mr-3"></i>Entry Fee & Prize Distribution
            </h2>
            <div class="overflow-x-auto rounded-xl">
                <table class="min-w-full">
                    <thead>
                        <tr class="uppercase text-sm leading-normal">
                            <th class="py-4 px-6 text-left rounded-tl-lg">Match Type</th>
                            <th class="py-4 px-6 text-left">Entry Fee</th>
                            <th class="py-4 px-6 text-left">Example (Players)</th>
                            <th class="py-4 px-6 text-left">Total Fee</th>
                            <th class="py-4 px-6 text-left">Prize Pool</th>
                            <th class="py-4 px-6 text-left rounded-tr-lg">Prize Distribution</th>
                        </tr>
                    </thead>
                    <tbody id="prizeTableBody" class="text-base font-light">
                        <tr>
                            <td colspan="6" class="py-6 text-center text-gray-400" id="loadingPrizeMessage">Loading prize information...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <p id="noPrizeMessage" class="hidden text-center text-gray-400 mt-6">No prize distribution information configured yet.</p>
        </section>

        <section class="w-full mb-12 card-base section-light-green-tint animate-fade-in-up">
            <h2 class="text-3xl lg:text-4xl font-bold mb-8 text-center flex items-center justify-center">
                <i class="fas fa-book text-red-400 mr-3"></i>Tournament Rules & Conditions
            </h2>
            <div id="rulesContent" class="direct-content-area">
                <p class="text-center text-gray-400">Loading rules...</p>
            </div>
        </section>

        <section class="w-full card-base section-light-orange-tint animate-fade-in-up">
            <h2 class="text-3xl lg:text-4xl font-bold mb-8 text-center flex items-center justify-center">
                <i class="fas fa-headset text-teal-400 mr-3"></i>Contact & Support
            </h2>
            <div id="contactContent" class="direct-content-area">
                <p class="text-center text-gray-400">Loading contact information...</p>
            </div>
        </section>

        <footer class="w-full mt-12 text-center text-gray-400 py-6">
            <p>© 2025 THA Tournaments. All rights reserved.</p>
            <p class="mt-2 text-sm">Designed for competitive gaming enthusiasts</p>
        </footer>
    </div>

    <div id="customModal" class="custom-modal">
        <div class="custom-modal-content">
            <span class="custom-modal-close-button" onclick="closeModal()">&times;</span>
            <div id="modalContent" class="py-6 px-4 sm:px-6">
                <!-- Modal content will be inserted here -->
            </div>
            <div id="modalButtons" class="mt-8 flex justify-center space-x-4">
                <button id="modalConfirmBtn" class="hidden btn-primary-modal">
                    Confirm
                </button>
                <button id="modalCancelBtn" class="hidden btn-secondary-modal" onclick="closeModal()">
                    Cancel
                </button>
                <button id="modalOkBtn" class="btn-primary-modal" onclick="closeModal()">
                    OK
                </button>
            </div>
        </div>
    </div>

    <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyD48ch2_ZWn2XPuV-G6wU4Wm3BI1YVGASw",
        authDomain: "tournaments-a652c.firebaseapp.com",
        projectId: "tournaments-a652c",
        storageBucket: "tournaments-a652c.appspot.com",
        messagingSenderId: "989795533335",
        appId: "1:989795533335:web:b45cb8f8c7853b7f1e5252",
        measurementId: "G-M3XGTFTQ4G"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    let currentUser = null;
    let currentMaxTeammates = 0;
    let activeTimers = [];
    
    // ===== TIMER FUNCTIONS =====
    function getTimeUntilMatch(matchTimeStr) {
        const now = new Date();
        const [hours, minutes] = matchTimeStr.split(':').map(Number);
        
        const matchDate = new Date();
        matchDate.setHours(hours, minutes, 0, 0);
        
        if (matchDate < now) {
            matchDate.setDate(matchDate.getDate() + 1);
        }
        
        const diff = matchDate - now;
        
        const hoursLeft = Math.floor(diff / (1000 * 60 * 60));
        const minutesLeft = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
        const secondsLeft = Math.floor((diff % (1000 * 60)) / 1000);
        
        return {
            hours: hoursLeft,
            minutes: minutesLeft,
            seconds: secondsLeft,
            matchDate: matchDate
        };
    }
    
    function formatTimeUnit(value) {
        return value.toString().padStart(2, '0');
    }
    
    function startMatchTimer(matchId, matchTime) {
        const timerElement = document.getElementById(`timer-${matchId}`);
        if (!timerElement) return;
        
        const timerInterval = setInterval(() => {
            const timeData = getTimeUntilMatch(matchTime);
            
            if (timeData.hours <= 0 && timeData.minutes <= 0 && timeData.seconds <= 0) {
                timerElement.innerHTML = `<span class="text-red-500 font-bold">Match Started!</span>`;
                clearInterval(timerInterval);
                return;
            }
            
            if (timeData.hours === 0 && timeData.minutes < 30) {
                timerElement.innerHTML = `
                    <span class="text-orange-400 font-bold">
                        ${formatTimeUnit(timeData.minutes)}m ${formatTimeUnit(timeData.seconds)}s
                    </span>
                `;
            } else {
                timerElement.innerHTML = `
                    <span class="text-green-400 font-medium">
                        ${formatTimeUnit(timeData.hours)}h ${formatTimeUnit(timeData.minutes)}m
                    </span>
                `;
            }
        }, 1000);
        
        activeTimers.push({
            id: matchId,
            interval: timerInterval
        });
    }
    
    function clearAllTimers() {
        activeTimers.forEach(timer => clearInterval(timer.interval));
        activeTimers = [];
    }
    
    // ===== MODAL FUNCTIONS =====
    window.openModal = (messageHtml, type = 'ok') => {
        return new Promise((resolve) => {
            const modalContentEl = document.getElementById('modalContent');
            const customModalEl = document.getElementById('customModal');
            const modalOkBtn = document.getElementById('modalOkBtn');
            const modalConfirmBtn = document.getElementById('modalConfirmBtn');
            const modalCancelBtn = document.getElementById('modalCancelBtn');

            if (!modalContentEl || !customModalEl || !modalOkBtn || !modalConfirmBtn || !modalCancelBtn) {
                console.error("Modal elements not found");
                resolve(false);
                return;
            }

            modalContentEl.innerHTML = `<div class="text-lg text-gray-200">${messageHtml}</div>`;
            
            modalOkBtn.classList.add('hidden');
            modalConfirmBtn.classList.add('hidden');
            modalCancelBtn.classList.add('hidden');

            if (type === 'confirm_cancel') {
                modalConfirmBtn.classList.remove('hidden');
                modalCancelBtn.classList.remove('hidden');
                modalConfirmBtn.onclick = () => { closeModal(); resolve(true); };
                modalCancelBtn.onclick = () => { closeModal(); resolve(false); };
            } else {
                modalOkBtn.classList.remove('hidden');
                modalOkBtn.onclick = () => { closeModal(); resolve(true); };
            }
            
            customModalEl.classList.add('flex');
        });
    };

    window.closeModal = () => {
        const customModalEl = document.getElementById('customModal');
        if (customModalEl) customModalEl.classList.remove('flex');
    };

    // ===== AUTH MODALS =====
    const showLoginRegisterModal = () => {
        document.getElementById('modalContent').innerHTML = `
            <h3 class="text-2xl font-bold text-indigo-300 mb-6 text-center">Login / Register</h3>
            <form id="authForm" class="space-y-4">
                <div>
                    <label for="authEmail" class="block text-gray-300 text-sm font-bold mb-2">Email:</label>
                    <input type="email" id="authEmail" class="w-full py-2 px-3" placeholder="your@example.com" required>
                </div>
                <div>
                    <label for="authPassword" class="block text-gray-300 text-sm font-bold mb-2">Password:</label>
                    <input type="password" id="authPassword" class="w-full py-2 px-3" placeholder="Minimum 6 characters" required>
                </div>
                <button type="submit" id="loginBtn" class="modern-btn w-full">
                    Login <i class="fas fa-sign-in-alt ml-2"></i>
                </button>
                <button type="button" id="registerNewBtn" class="modern-btn !bg-green-600 w-full mt-2">
                    Register New Account <i class="fas fa-user-plus ml-2"></i>
                </button>
            </form>
            <p id="authError" class="text-red-400 text-center mt-4"></p>
        `;
        document.getElementById('customModal').classList.add('flex');

        document.getElementById('authForm').addEventListener('submit', (e) => {
            e.preventDefault();
            handleAuth(document.getElementById('authEmail').value, document.getElementById('authPassword').value, 'login');
        });
        
        document.getElementById('registerNewBtn').addEventListener('click', () => {
            handleAuth(document.getElementById('authEmail').value, document.getElementById('authPassword').value, 'register');
        });
    };

    const handleAuth = async (email, password, type) => {
        const authError = document.getElementById('authError');
        authError.textContent = '';

        try {
            if (type === 'login') {
                await signInWithEmailAndPassword(auth, email, password);
                await openModal('Login successful! Welcome back.', 'ok');
                closeModal();
            } else {
                await createUserWithEmailAndPassword(auth, email, password);
                await openModal('Registration successful! You are now logged in.', 'ok');
                closeModal();
            }
        } catch (error) {
            let errorMessage = 'An unknown error occurred.';
            switch (error.code) {
                case 'auth/user-not-found':
                case 'auth/wrong-password':
                case 'auth/invalid-credential':
                    errorMessage = 'Invalid email or password.';
                    break;
                case 'auth/email-already-in-use':
                    errorMessage = 'This email is already registered.';
                    break;
                case 'auth/weak-password':
                    errorMessage = 'Password must be at least 6 characters.';
                    break;
                case 'auth/invalid-email':
                    errorMessage = 'Invalid email address format.';
                    break;
                default:
                    errorMessage = `Authentication error: ${error.message}`;
            }
            authError.textContent = errorMessage;
        }
    };

    // ===== CORE TOURNAMENT FUNCTIONS =====
    function isMatchOpenForRegistration(matchTimeStr) {
        try {
            const now = new Date();
            const [hours, minutes] = matchTimeStr.split(':').map(Number);
            const matchDateTime = new Date(now.getFullYear(), now.getMonth(), now.getDate(), hours, minutes, 0);
            const registrationCloseTime = new Date(matchDateTime.getTime() - 20 * 60 * 1000);
            return now < registrationCloseTime;
        } catch (e) {
            console.error("Error parsing match time:", e);
            return false;
        }
    }

    const fetchAndDisplayMatchSlots = async () => {
        const matchesContainer = document.getElementById('matchesContainer');
        const matchSelect = document.getElementById('matchSelect');
        const loadingMatchesMessage = document.getElementById('loadingMatchesMessage');
        const noMatchesMessage = document.getElementById('noMatchesMessage');

        matchesContainer.innerHTML = '';
        matchSelect.innerHTML = '<option value="">-- Loading Matches --</option>';
        loadingMatchesMessage.classList.remove('hidden');
        noMatchesMessage.classList.add('hidden');

        try {
            // Simulated API response with mock data
            const mockMatchSlots = [
                {
                    id: "1",
                    type: "Solo Match",
                    time: "15:00",
                    min_players: 1,
                    max_players: 50,
                    entry: 25,
                    prize: "₹1,250",
                    active: true
                },
                {
                    id: "2",
                    type: "Duo Match",
                    time: "17:30",
                    min_players: 2,
                    max_players: 25,
                    entry: 45,
                    prize: "₹1,125",
                    active: true
                },
                {
                    id: "3",
                    type: "Squad Match",
                    time: "20:00",
                    min_players: 4,
                    max_players: 12,
                    entry: 180,
                    prize: "₹2,160",
                    active: true
                }
            ];

            loadingMatchesMessage.classList.add('hidden');

            const activeUpcomingMatches = mockMatchSlots.filter(match => 
                match.active && isMatchOpenForRegistration(match.time)
            );

            if (activeUpcomingMatches.length > 0) {
                activeUpcomingMatches.sort((a, b) => a.time.localeCompare(b.time));

                matchesContainer.innerHTML = '';
                matchSelect.innerHTML = '<option value="">-- Select Match Type & Time --</option>';
                
                activeUpcomingMatches.forEach(match => {
                    const timeData = getTimeUntilMatch(match.time);
                    let timerHtml = '';
                    
                    if (timeData.hours <= 0 && timeData.minutes <= 0 && timeData.seconds <= 0) {
                        timerHtml = `<p class="text-red-400 font-bold mt-3">Match Started!</p>`;
                    } else {
                        timerHtml = `
                            <p class="text-sm text-gray-400 mt-2">Starts in:</p>
                            <p id="timer-${match.id}" class="text-lg font-bold text-green-400">
                                ${formatTimeUnit(timeData.hours)}h ${formatTimeUnit(timeData.minutes)}m
                            </p>
                        `;
                    }
                    
                    const cardHtml = `
                        <div class="card-base p-6 border-l-4 border-indigo-500 transform transition duration-300 hover:scale-[1.02]">
                            <h3 class="text-xl font-bold text-indigo-300 mb-2">${match.type}</h3>
                            <p class="text-gray-300 mb-1"><i class="fas fa-clock mr-2 text-blue-400"></i>Time: <span class="font-semibold">${match.time}</span></p>
                            <p class="text-gray-300 mb-1"><i class="fas fa-users mr-2 text-purple-400"></i>Players: <span class="font-semibold">${match.min_players} - ${match.max_players}</span></p>
                            <p class="text-gray-300 mb-1"><i class="fas fa-rupee-sign mr-2 text-yellow-400"></i>Entry: <span class="font-semibold">₹${(match.entry || 0).toFixed(2)}</span></p>
                            <p class="text-gray-300"><i class="fas fa-trophy mr-2 text-amber-400"></i>Prize: <span class="font-semibold">${match.prize || 'N/A'}</span></p>
                            
                            <div class="mt-4 text-center">
                                ${timerHtml}
                            </div>
                            
                            <button data-match-id="${match.id}" data-match-type="${match.type}" data-match-time="${match.time}" 
                                    class="register-btn mt-6 modern-btn w-full">
                                Register Now!
                            </button>
                        </div>
                    `;
                    matchesContainer.insertAdjacentHTML('beforeend', cardHtml);
                    matchSelect.insertAdjacentHTML('beforeend', `<option value="${match.id}" data-match-type="${match.type}" data-match-time="${match.time}">${match.time} - ${match.type}</option>`);
                    
                    if (!(timeData.hours <= 0 && timeData.minutes <= 0 && timeData.seconds <= 0)) {
                        startMatchTimer(match.id, match.time);
                    }
                });

                document.querySelectorAll('.register-btn').forEach(button => {
                    button.addEventListener('click', () => {
                        const matchId = button.dataset.matchId;
                        document.getElementById('matchSelect').value = matchId;
                        document.getElementById('registrationForm').scrollIntoView({ behavior: 'smooth' });
                        const event = new Event('change');
                        document.getElementById('matchSelect').dispatchEvent(event);
                    });
                });

            } else {
                noMatchesMessage.classList.remove('hidden');
                matchSelect.innerHTML = '<option value="">-- No active matches --</option>';
            }
        } catch (error) {
            console.error('Error loading matches:', error);
            loadingMatchesMessage.textContent = 'Failed to load matches. Please try again later.';
            await openModal('Failed to load match data. Please check your connection.');
        }
        populateDailyMatchSlots(mockMatchSlots);
    };

    let loadedMatchSlots = [];

    const populateDailyMatchSlots = (matchSlots) => {
        loadedMatchSlots = matchSlots;
    };

    // ===== TEAMMATE INPUT MANAGEMENT =====
    function addTeammateInput(index, isInitial = false) {
        const teammatesList = document.getElementById('teammatesList');
        const div = document.createElement('div');
        div.className = 'teammate-entry';
        div.innerHTML = `
            <input type="text" class="teammate-ign" placeholder="Teammate IGN" required>
            <input type="text" class="teammate-ffid" placeholder="Teammate FFID" required>
            ${isInitial ? '' : '<button type="button" class="remove-teammate-btn"><i class="fas fa-times"></i></button>'}
        `;
        teammatesList.appendChild(div);

        if (!isInitial) {
            const removeBtn = div.querySelector('.remove-teammate-btn');
            removeBtn.addEventListener('click', () => {
                div.remove();
                document.getElementById('addTeammateButton').classList.remove('hidden');
            });
        }
    }

    const updateTeammateInputs = () => {
        const matchSelect = document.getElementById('matchSelect');
        const teammatesSection = document.getElementById('teammatesSection');
        const teammatesList = document.getElementById('teammatesList');
        const addTeammateButton = document.getElementById('addTeammateButton');

        teammatesList.innerHTML = '';
        addTeammateButton.onclick = null;
        addTeammateButton.classList.remove('hidden');

        const selectedMatchId = matchSelect.value;
        const selectedMatch = loadedMatchSlots.find(slot => slot.id === selectedMatchId);

        if (selectedMatch) {
            const matchType = selectedMatch.type.toLowerCase();
            currentMaxTeammates = 0;
            
            if (matchType.includes('solo')) {
                teammatesSection.classList.add('hidden');
            } else if (matchType.includes('duo')) {
                currentMaxTeammates = 1;
                teammatesSection.classList.remove('hidden');
                addTeammateInput(1, true);
                addTeammateButton.classList.add('hidden');
            } else if (matchType.includes('squad') || matchType.includes('team')) {
                currentMaxTeammates = 3;
                teammatesSection.classList.remove('hidden');
                addTeammateInput(1, true);
                addTeammateButton.classList.remove('hidden');
            }

            addTeammateButton.addEventListener('click', () => {
                const currentTeammates = teammatesList.children.length;
                if (currentTeammates < currentMaxTeammates) {
                    addTeammateInput(currentTeammates + 1);
                    if (teammatesList.children.length >= currentMaxTeammates) {
                        addTeammateButton.classList.add('hidden');
                    }
                } else {
                    openModal('Maximum teammates reached for this match type.');
                }
            });
        } else {
            teammatesSection.classList.add('hidden');
        }
    };

    // Submit Registration
    document.getElementById('registrationForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const registrationMessage = document.getElementById('registrationMessage');
        registrationMessage.classList.add('hidden');

        if (!currentUser) {
            registrationMessage.textContent = 'Please log in or register to participate.';
            registrationMessage.classList.remove('hidden');
            showLoginRegisterModal();
            return;
        }

        const matchSelect = document.getElementById('matchSelect');
        const selectedMatchId = matchSelect.value;
        const selectedMatchOption = matchSelect.options[matchSelect.selectedIndex];
        const matchType = selectedMatchOption.dataset.matchType;
        const matchTime = selectedMatchOption.dataset.matchTime;

        const iglIGN = document.getElementById('iglIGN').value;
        const iglFFID = document.getElementById('iglFFID').value;

        const teammates = [];
        const teammateIGNs = document.querySelectorAll('.teammate-ign');
        const teammateFFIDs = document.querySelectorAll('.teammate-ffid');

        for (let i = 0; i < teammateIGNs.length; i++) {
            if (teammateIGNs[i].value && teammateFFIDs[i].value) {
                teammates.push({
                    ign: teammateIGNs[i].value,
                    ffid: teammateFFIDs[i].value
                });
            } else {
                await openModal('Please fill in all teammate details.', 'ok');
                return;
            }
        }

        const matchTypeLower = matchType.toLowerCase();
        let requiredTeammates = 0;
        if (matchTypeLower.includes('duo')) {
            requiredTeammates = 1;
        } else if (matchTypeLower.includes('squad') || matchTypeLower.includes('team')) {
            requiredTeammates = 3;
        }

        if (teammates.length !== requiredTeammates) {
            await openModal(`This match requires exactly ${requiredTeammates} teammate(s).`);
            return;
        }

        const registrationData = {
            userId: currentUser.uid,
            email: currentUser.email,
            matchId: selectedMatchId,
            matchType: matchType,
            matchTime: matchTime,
            iglIGN: iglIGN,
            iglFFID: iglFFID,
            teammates: teammates,
            clientTime: new Date().toISOString()
        };

        const registerButton = document.getElementById('registerButton');
        registerButton.disabled = true;
        registerButton.textContent = 'Registering...';

        // Simulate API call
        setTimeout(async () => {
            registerButton.disabled = false;
            registerButton.textContent = 'Register Now!';
            await openModal('Registration successful! Your team has been registered for the tournament.');
            document.getElementById('registrationForm').reset();
            updateTeammateInputs();
        }, 1500);
    });

    // ===== DYNAMIC CONTENT DISPLAY FUNCTIONS =====
    const fetchAndDisplayWebsiteContent = async () => {
        const rulesContentDiv = document.getElementById('rulesContent');
        const contactContentDiv = document.getElementById('contactContent');

        // Mock rules content
        const mockRules = `
        <h3 class="text-xl font-bold text-indigo-300 mb-4">Tournament Rules</h3>
        <ul class="list-disc pl-6 space-y-2">
            <li>All players must have a valid Free Fire account</li>
            <li>No cheating or use of third-party tools is allowed</li>
            <li>Players must join the match lobby 15 minutes before start time</li>
            <li>Team names must be appropriate and not offensive</li>
            <li>Decisions by tournament administrators are final</li>
            <li>Entry fees are non-refundable once registration is confirmed</li>
        </ul>
        `;

        // Mock contact content
        const mockContact = `
        <h3 class="text-xl font-bold text-indigo-300 mb-4">Contact & Support</h3>
        <div class="space-y-3">
            <p><i class="fas fa-envelope mr-3 text-blue-400"></i>Email: support@thatournaments.com</p>
            <p><i class="fab fa-whatsapp mr-3 text-green-400"></i>WhatsApp: +91 98765 43210</p>
            <p><i class="fab fa-discord mr-3 text-indigo-400"></i>Discord: discord.gg/thatournaments</p>
            <p><i class="fas fa-headset mr-3 text-amber-400"></i>Support Hours: 10 AM - 10 PM IST</p>
        </div>
        `;

        rulesContentDiv.innerHTML = mockRules;
        contactContentDiv.innerHTML = mockContact;
    };

    const fetchAndDisplayScheduleItems = async () => {
        const scheduleTableBody = document.getElementById('scheduleTableBody');
        const loadingScheduleMessage = document.getElementById('loadingScheduleMessage');
        const noScheduleMessage = document.getElementById('noScheduleMessage');

        scheduleTableBody.innerHTML = '';
        loadingScheduleMessage.classList.remove('hidden');
        noScheduleMessage.classList.add('hidden');

        // Mock schedule data
        const mockSchedule = [
            { time: "12:00 PM", description: "Registration Opens", notes: "All match types" },
            { time: "02:00 PM", description: "Solo Match Briefing", notes: "Mandatory for participants" },
            { time: "03:00 PM", description: "Solo Match Starts", notes: "50 players" },
            { time: "04:30 PM", description: "Duo Match Briefing", notes: "Team check-in" },
            { time: "05:30 PM", description: "Duo Match Starts", notes: "25 teams" },
            { time: "07:00 PM", description: "Squad Match Briefing", notes: "Team check-in" },
            { time: "08:00 PM", description: "Squad Match Starts", notes: "12 teams" },
            { time: "10:00 PM", description: "Prize Distribution", notes: "All winners" }
        ];

        loadingScheduleMessage.classList.add('hidden');

        mockSchedule.forEach(item => {
            const row = `
                <tr class="border-b border-slate-700 hover:bg-slate-800 transition-colors">
                    <td class="py-4 px-6 font-bold text-amber-300">${item.time}</td>
                    <td class="py-4 px-6">${item.description}</td>
                    <td class="py-4 px-6 text-gray-400">${item.notes}</td>
                </tr>
            `;
            scheduleTableBody.insertAdjacentHTML('beforeend', row);
        });
    };

    const fetchAndDisplayPrizeItems = async () => {
        const prizeTableBody = document.getElementById('prizeTableBody');
        const loadingPrizeMessage = document.getElementById('loadingPrizeMessage');
        const noPrizeMessage = document.getElementById('noPrizeMessage');

        prizeTableBody.innerHTML = '';
        loadingPrizeMessage.classList.remove('hidden');
        noPrizeMessage.classList.add('hidden');

        // Mock prize data
        const mockPrizes = [
            { 
                matchType: "Solo Match", 
                entryFee: "₹25", 
                totalPlayersExample: "50 players", 
                totalFee: "₹1,250", 
                prizePool: "₹1,250", 
                prizeDistribution: "1st: ₹500, 2nd: ₹300, 3rd: ₹200, 4th-10th: ₹35" 
            },
            { 
                matchType: "Duo Match", 
                entryFee: "₹45 per team", 
                totalPlayersExample: "25 teams", 
                totalFee: "₹1,125", 
                prizePool: "₹1,125", 
                prizeDistribution: "1st: ₹500, 2nd: ₹300, 3rd: ₹200, 4th-5th: ₹62.50" 
            },
            { 
                matchType: "Squad Match", 
                entryFee: "₹180 per team", 
                totalPlayersExample: "12 teams", 
                totalFee: "₹2,160", 
                prizePool: "₹2,160", 
                prizeDistribution: "1st: ₹1,000, 2nd: ₹600, 3rd: ₹400, 4th: ₹160" 
            }
        ];

        loadingPrizeMessage.classList.add('hidden');

        mockPrizes.forEach(item => {
            const row = `
                <tr class="border-b border-slate-700 hover:bg-slate-800">
                    <td class="py-4 px-6">${item.matchType}</td>
                    <td class="py-4 px-6">${item.entryFee}</td>
                    <td class="py-4 px-6">${item.totalPlayersExample}</td>
                    <td class="py-4 px-6">${item.totalFee}</td>
                    <td class="py-4 px-6">${item.prizePool}</td>
                    <td class="py-4 px-6">${item.prizeDistribution}</td>
                </tr>
            `;
            prizeTableBody.insertAdjacentHTML('beforeend', row);
        });
    };

    // ===== AUTH STATE HANDLER =====
    onAuthStateChanged(auth, (user) => {
        const loadingScreen = document.getElementById('loadingScreen');
        const mainContent = document.getElementById('mainContent');
        const authButton = document.getElementById('authButton');
        const myRegistrationsButton = document.getElementById('myRegistrationsButton');
        const logoutButton = document.getElementById('logoutButton');
        const loggedInEmailSpan = document.getElementById('loggedInEmail');
        const loggedInUserInfo = document.getElementById('loggedInUserInfo');
        const regEmail = document.getElementById('regEmail');
        const regUserId = document.getElementById('regUserId');
        const loginPrompt = document.getElementById('loginPrompt');
        const registerButton = document.getElementById('registerButton');
        
        // Show content after auth check
        setTimeout(() => {
            if (loadingScreen) loadingScreen.classList.add('hidden');
            if (mainContent) mainContent.classList.remove('hidden');
        }, 1500);
        
        currentUser = user;
        if (user) {
            if (loggedInEmailSpan) loggedInEmailSpan.textContent = user.email || "User";
            if (logoutButton) logoutButton.classList.remove('hidden');
            if (myRegistrationsButton) myRegistrationsButton.classList.remove('hidden');
            
            if (loggedInUserInfo) loggedInUserInfo.classList.remove('hidden');
            if (regEmail) regEmail.textContent = user.email || "User";
            if (regUserId) regUserId.textContent = user.uid.substring(0, 8) + "...";
            if (loginPrompt) loginPrompt.classList.add('hidden');
            if (registerButton) registerButton.disabled = false;
        } else {
            if (loggedInEmailSpan) loggedInEmailSpan.textContent = 'Guest';
            if (logoutButton) logoutButton.classList.add('hidden');
            if (myRegistrationsButton) myRegistrationsButton.classList.add('hidden');
            
            if (loggedInUserInfo) loggedInUserInfo.classList.add('hidden');
            if (loginPrompt) loginPrompt.classList.remove('hidden');
            if (registerButton) registerButton.disabled = true;
        }
    });

    // ===== EVENT LISTENERS AND INITIAL LOAD =====
    document.addEventListener('DOMContentLoaded', () => {
        // Set up event listeners
        document.getElementById('authButton').addEventListener('click', showLoginRegisterModal);
        document.getElementById('matchSelect').addEventListener('change', updateTeammateInputs);
        
        document.getElementById('logoutButton').addEventListener('click', async () => {
            try {
                await signOut(auth);
                window.location.reload();
            } catch (error) {
                console.error("Logout error:", error);
                openModal("Logout failed. Please try again.");
            }
        });
        
        document.getElementById('walletButton').addEventListener('click', () => {
            openModal("Wallet functionality is coming soon! You'll be able to manage your tournament funds here.", 'ok');
        });

        // Initial fetches for dynamic content
        fetchAndDisplayMatchSlots();
        fetchAndDisplayWebsiteContent();
        fetchAndDisplayScheduleItems();
        fetchAndDisplayPrizeItems();
        
        // Clear timers when page is unloaded
        window.addEventListener('beforeunload', clearAllTimers);
    });
    </script>
</body>
</html>
