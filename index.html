<!DOCTYPE html>
<html lang="en">
<head>
    <base href="/tha-tournaments-frontend/">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>THA Tournaments</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Custom Fonts from Google Fonts */
        @import url('https://fonts.googleapis.com/css2?family=Oxanium:wght@500;700&family=Inter:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            /* Changed to transparent background */
            background: transparent;
            color: #334155; /* Dark gray for main text */
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: 2.5rem;
            padding-bottom: 2.5rem;
        }

        /* Video Background Styling - Increased brightness */
        #background-video {
            position: fixed;
            right: 0;
            bottom: 0;
            min-width: 100%;
            min-height: 100%;
            width: auto;
            height: auto;
            z-index: -100;
            object-fit: cover; /* Ensures the video covers the screen without distortion */
            filter: brightness(0.8); /* Reduced dim effect for better visibility */
        }

        /* REMOVED the overlay div completely */

        h1, h2, h3 {
            font-family: 'Oxanium', sans-serif;
            color: #FFFFFF; /* Changed to white for better visibility on dark background */
        }
        h1 {
            text-shadow: 2px 2px 8px rgba(0,0,0,0.7); /* Enhanced shadow for readability */
        }
        h2 {
            color: #1F2937; /* Main section headings */
        }

        /* Keyframe Animations */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes slideInLeft {
            from { opacity: 0; transform: translateX(-50px); }
            to { opacity: 1; transform: translateX(0); }
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        @keyframes futuristicGlow {
            0%, 100% {
                box-shadow: 0 0 5px rgba(96, 165, 250, 0.2), 0 0 10px rgba(96, 165, 250, 0.2), 0 0 20px rgba(96, 165, 250, 0.2);
            }
            50% {
                box-shadow: 0 0 10px rgba(96, 165, 250, 0.5), 0 0 20px rgba(96, 165, 250, 0.5), 0 0 40px rgba(96, 165, 250, 0.5);
            }
        }


        /* Applying Animations */
        .animate-fade-in { animation: fadeIn 0.8s ease-out forwards; }
        .animate-fade-in-up { animation: fadeInUp 0.7s ease-out forwards; }
        .animate-slide-in-left { animation: slideInLeft 0.9s ease-out forwards; }
        .loading-animation {
            border: 4px solid rgba(150, 150, 150, 0.3);
            border-top: 4px solid #60A5FA; /* Soft blue */
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1.2s cubic-bezier(0.68, -0.55, 0.27, 1.55) infinite;
        }

        /* Base element styling - MADE MORE TRANSPARENT */
        .card-base {
            background-color: rgba(255, 255, 255, 0.7); /* Increased transparency */
            border: 1px solid rgba(226, 232, 240, 0.5); /* Lighter border */
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.15); /* Slightly stronger shadow */
            border-radius: 1rem;
            padding: 3rem;
            transition: all 0.3s ease-in-out;
            backdrop-filter: blur(8px); /* Stronger frosted glass effect */
        }
        .card-base:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2); /* More pronounced shadow on hover */
        }

        /* Header specific styles - MADE MORE TRANSPARENT */
        header.card-base {
            background-color: rgba(255, 255, 255, 0.75); /* More transparent for header */
            animation: futuristicGlow 4s ease-in-out infinite;
        }

        /* Button styles */
        .modern-btn {
            background: linear-gradient(45deg, #60A5FA, #3B82F6); /* Soft blue gradient */
            color: #FFF;
            font-weight: 600;
            padding: 0.9rem 2.2rem;
            border-radius: 0.75rem; /* More rounded */
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2); /* Soft shadow */
            transition: all 0.3s ease-in-out;
            border: none;
            cursor: pointer;
            background-size: 200% auto;
            position: relative; /* For pseudo-element glow */
            overflow: hidden;
            z-index: 1;
        }
        .modern-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.1); /* Subtle internal light shimmer */
            transform: scaleX(0);
            transform-origin: left;
            transition: transform 0.4s ease-out;
            z-index: -1;
        }
        .modern-btn:hover::before {
            transform: scaleX(1);
        }
        .modern-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 18px rgba(0, 0, 0, 0.3); /* Lifted shadow */
            background-position: right center; /* Gradient shift */
        }
        .modern-btn:disabled {
            background: #CBD5E1;
            color: #64748B;
            box-shadow: none;
            cursor: not-allowed;
            opacity: 0.7;
            transform: none;
        }

        /* Form input styles */
        input[type="text"], input[type="email"], input[type="password"], input[type="number"], textarea, select {
            background-color: rgba(248, 250, 252, 0.7); /* Slightly transparent */
            border: 1px solid #CBD5E1; /* Subtle border */
            color: #334155;
            border-radius: 0.6rem;
            padding: 0.8rem 1.2rem;
            transition: all 0.2s ease-in-out;
            backdrop-filter: blur(5px); /* Frosted effect */
        }
        input[type="text"]::placeholder, input[type="email"]::placeholder, input[type="password"]::placeholder, textarea::placeholder, select::placeholder {
            color: #94A3B8; /* Muted placeholder text */
        }
        input[type="text"]:focus, input[type="email"]:focus, input[type="password"]:focus, input[type="number"]:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #60A5FA; /* Soft blue focus glow */
            box-shadow: 0 0 10px rgba(96, 165, 250, 0.4);
        }
        
        /* Table styles - MADE MORE TRANSPARENT */
        table {
            background-color: rgba(255, 255, 255, 0.7); /* Transparent white */
            border-radius: 1rem;
            overflow: hidden;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(5px); /* Frosted effect */
        }
        th {
            background: rgba(226, 232, 240, 0.7); /* Light gray header background */
            color: #475569; /* Darker gray for headers */
            font-weight: 600;
            padding: 1.2rem 1.5rem;
        }
        td {
            border-bottom: 1px solid rgba(226, 232, 240, 0.5); /* Lighter border */
            color: #475569;
            padding: 1rem 1.5rem;
        }
        tbody tr:last-child td {
            border-bottom: none;
        }
        tbody tr:hover {
            background-color: rgba(240, 244, 248, 0.5); /* Subtle light gray hover effect */
        }

        /* Section specific styles - MADE MORE TRANSPARENT */
        .section-light-blue-tint { 
            background-color: rgba(248, 250, 252, 0.7);
            border-left: 5px solid rgba(165, 214, 249, 0.7); /* Very light blue accent */
        }
        .section-light-green-tint {
            background-color: rgba(248, 250, 252, 0.7);
            border-left: 5px solid rgba(129, 199, 132, 0.7); /* Very light green accent */
        }
        .section-light-orange-tint {
            background-color: rgba(248, 250, 252, 0.7);
            border-left: 5px solid rgba(255, 204, 128, 0.7); /* Very light orange accent */
        }

        /* Content areas - MADE MORE TRANSPARENT */
        .direct-content-area {
            background-color: rgba(240, 244, 248, 0.7); /* Transparent background */
            border: 1px solid rgba(209, 216, 224, 0.5); /* Lighter border */
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.05);
            padding: 2rem;
            border-radius: 0.75rem;
            white-space: pre-wrap;
            line-height: 1.6;
            color: #475569;
            backdrop-filter: blur(5px); /* Frosted effect */
        }

        /* Custom Modal Styling - Adapting to theme */
        .custom-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.4); /* Semi-transparent dark overlay */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-out, visibility 0.3s ease-out;
        }
        .custom-modal.flex {
            opacity: 1;
            visibility: visible;
        }
        .custom-modal-content {
            background-color: rgba(255, 255, 255, 0.85); /* Semi-transparent white */
            color: #334155;
            border: 1px solid #D1D8E0;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.25);
            border-radius: 1rem;
            padding: 2.5rem;
            position: relative;
            transform: translateY(20px);
            transition: transform 0.3s ease-out;
            backdrop-filter: blur(10px); /* Strong frosted effect */
        }
        .custom-modal.flex .custom-modal-content {
            transform: translateY(0);
        }
        .custom-modal-close-button {
            color: #64748B;
            font-size: 2rem;
            font-weight: 300;
            cursor: pointer;
            transition: color 0.2s ease-in-out;
        }
        .custom-modal-close-button:hover {
            color: #EF4444;
        }
        .custom-modal .btn-primary-modal {
            background: linear-gradient(45deg, #60A5FA, #3B82F6);
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.15);
            color: #FFF;
            font-weight: 600;
            padding: 0.75rem 1.75rem;
            border-radius: 0.6rem;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .custom-modal .btn-primary-modal:hover {
            box-shadow: 0 5px 12px rgba(0, 0, 0, 0.25);
            transform: translateY(-1px);
        }
        .custom-modal .btn-secondary-modal {
            background-color: #E2E8F0;
            color: #475569;
            border: 1px solid #CBD5E1;
            font-weight: 500;
            padding: 0.75rem 1.75rem;
            border-radius: 0.6rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .custom-modal .btn-secondary-modal:hover {
            background-color: #D1D8E0;
            color: #334155;
        }

        /* Icon Colors */
        .text-purple-500 {
            color: #8B5CF6;
        }
        .text-blue-500 {
            color: #3B82F6;
        }
        .text-indigo-500 {
            color: #6366F1;
        }
        .text-yellow-500 {
            color: #F59E0B;
        }
        .text-red-500 {
            color: #EF4444;
        }
        .text-teal-500 {
            color: #10B981;
        }
        .modern-btn.\!bg-green-600 {
            background: linear-gradient(45deg, #34D399, #10B981);
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
        }
        .modern-btn.\!bg-green-600:hover {
            box-shadow: 0 8px 18px rgba(0,0,0,0.25);
        }
        .modern-btn.\!bg-red-500 {
            background: linear-gradient(45deg, #F87171, #EF4444);
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
        }
        .modern-btn.\!bg-red-500:hover {
            box-shadow: 0 8px 18px rgba(0,0,0,0.25);
        }
        .modern-btn.\!bg-gray-700 {
            background: #94A3B8;
            box-shadow: 0 3px 8px rgba(0,0,0,0.1);
        }
        .modern-btn.\!bg-gray-700:hover {
            background: #64748B;
            box-shadow: 0 5px 12px rgba(0,0,0,0.2);
        }
        .text-red-700 { color: #DC2626; }
        .text-cyan-300 { color: #60A5FA; }
        .text-gray-300 { color: #475569; }
        .text-blue-300 { color: #3B82F6; }
        .text-purple-300 { color: #8B5CF6; }
        .text-blue-400 { color: #3B82F6; }
        .text-purple-400 { color: #A78BFA; }
        .text-yellow-400 { color: #FBBF24; }
        .text-orange-400 { color: #FB923C; }
    </style>
</head>
<body class="py-8 px-4">
    
    <!-- REMOVED the overlay div -->
   

    <div id="loadingScreen" class="fixed inset-0 flex items-center justify-center bg-gray-100 z-50">
        <div class="flex flex-col items-center">
            <div class="loading-animation"></div>
            <p class="mt-4 text-xl font-semibold text-gray-700">Loading Tournament Site...</p>
        </div>
    </div>

    <div id="mainContent" class="hidden card-base max-w-7xl w-full flex flex-col items-center">

        <header class="text-center mb-12 w-full p-8 card-base shadow-lg animate-fade-in">
            <div class="flex justify-center items-center mb-4">
                <img src="logo.png" alt="THA Logo" width="100" height="50">&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp
                <h1 class="text-5xl lg:text-6xl font-extrabold animate-slide-in-left">
                      THA Tournaments
                </h1>
            </div>
            <p class="text-xl lg:text-2xl text-cyan-300 font-semibold mb-8 animate-fade-in">Join the ultimate tournament experience!</p>
            
            <div class="border-b-4 border-gray-200 mt-8 mb-6"></div>

            <div class="flex flex-col sm:flex-row justify-between items-center mt-4 space-y-4 sm:space-y-0 text-gray-700">
                <span class="text-md sm:text-lg font-medium text-center sm:text-left">
                    Welcome, <span class="font-bold text-red-700" id="loggedInEmail">Guest</span>!
                </span>
                <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-4 w-full sm:w-auto items-center sm:items-stretch">
    <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-4 w-full sm:w-auto items-center sm:items-stretch">
    <button id="authButton" class="modern-btn w-full sm:w-auto">
        <i class="fas fa-sign-in-alt mr-2"></i>Login / Register
    </button>

    <a href="/tha-tournaments-frontend/registered.html" id="myRegistrationsButton" class="hidden modern-btn !bg-green-600 hover:!bg-green-600 w-full sm:w-auto text-center">
    <i class="fas fa-clipboard-list mr-2"></i>My Registrations
</a>


    <button id="logoutButton" class="hidden modern-btn !bg-red-500 hover:!bg-red-500 w-full sm:w-auto">
        <i class="fas fa-sign-out-alt mr-2"></i>Logout
    </button>
</div>
            </div>
        </header>

        <section class="w-full mb-12 card-base section-light-blue-tint animate-fade-in-up">
            <h2 class="text-3xl lg:text-4xl font-bold mb-8 text-center flex items-center justify-center">
                <i class="fas fa-calendar-check text-purple-500 mr-3"></i>Current & Upcoming Matches
            </h2>
            <div id="matchesContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                <p class="text-center text-gray-600 md:col-span-3" id="loadingMatchesMessage">Loading matches...</p>
            </div>
            <p id="noMatchesMessage" class="hidden text-center text-gray-600 mt-6">No upcoming matches available for registration.</p>
        </section>

        <section class="w-full mb-12 card-base section-light-green-tint animate-fade-in-up">
            <h2 class="text-3xl lg:text-4xl font-bold mb-8 text-center flex items-center justify-center">
                <i class="fas fa-user-plus text-blue-500 mr-3"></i>Register for a Tournament
            </h2>
            <p id="registrationMessage" class="hidden text-center text-red-500 font-semibold mb-6"></p>
            <form id="registrationForm" class="space-y-6">
                <div id="loggedInUserInfo" class="hidden bg-[#EFF6FF] p-4 rounded-lg text-blue-800 font-medium border border-blue-200 shadow-sm">
                    Logged in as: <span id="regEmail" class="font-semibold"></span> (ID: <span id="regUserId" class="font-semibold"></span>)
                </div>
                <div id="loginPrompt" class="text-center text-red-500 font-bold hidden text-lg">
                    Please log in or register to participate in tournaments.
                </div>

                <div>
                    <label for="matchSelect" class="block text-gray-700 text-base font-bold mb-2">Select Match Type & Time:</label>
                    <select id="matchSelect" class="shadow-sm appearance-none border rounded-lg w-full py-3 px-4 focus:outline-none focus:ring-2 focus:ring-blue-300" required>
                        <option value="">-- Loading Matches --</option>
                    </select>
                </div>
                <div>
                    <label for="iglIGN" class="block text-gray-700 text-base font-bold mb-2">Your IGN (In-Game Name):</label>
                    <input type="text" id="iglIGN" class="shadow-sm appearance-none border rounded-lg w-full py-3 px-4" placeholder="Your Free Fire IGN" required>
                </div>
                <div>
                    <label for="iglFFID" class="block text-gray-700 text-base font-bold mb-2">Your FFID (Free Fire ID):</label>
                    <input type="text" id="iglFFID" class="shadow-sm appearance-none border rounded-lg w-full py-3 px-4" placeholder="Your 9-10 digit Free Fire ID" required>
                </div>
                <div id="teammatesSection" class="hidden border border-blue-200 p-6 rounded-lg bg-[#F8FAFC] shadow-sm">
                    <h3 class="text-xl font-bold text-blue-600 mb-4">Teammates (for Duo/Squad/Team Matches)</h3>
                    <div id="teammatesList" class="space-y-4">
                        </div>
                    <button type="button" id="addTeammateButton" class="mt-5 modern-btn !bg-gray-700 hover:!bg-gray-700">
                        <i class="fas fa-plus-circle mr-1"></i>Add Teammate
                    </button>
                </div>
                <button type="submit" id="registerButton" class="modern-btn w-full mt-6">
                    Register Now! <i class="fas fa-arrow-right ml-2"></i>
                </button>
            </form>
        </section>

        <section class="w-full mb-12 card-base section-light-orange-tint animate-fade-in-up">
            <h2 class="text-3xl lg:text-4xl font-bold mb-8 text-center flex items-center justify-center">
                <i class="fas fa-calendar-days text-indigo-500 mr-3"></i>Full Daily Schedule
            </h2>
            <div class="overflow-x-auto">
                <table class="min-w-full rounded-lg shadow-sm">
                    <thead>
                        <tr class="uppercase text-sm leading-normal">
                            <th class="py-4 px-6 text-left rounded-tl-lg">Time</th>
                            <th class="py-4 px-6 text-left">Event / Description</th>
                            <th class="py-4 px-6 text-left">Notes</th>
                        </tr>
                    </thead>
                    <tbody id="scheduleTableBody" class="text-base font-light">
                        <tr>
                            <td colspan="3" class="py-6 text-center text-gray-600" id="loadingScheduleMessage">Loading schedule...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <p id="noScheduleMessage" class="hidden text-center text-gray-600 mt-6">No schedule items configured yet.</p>
        </section>

        <section class="w-full mb-12 card-base section-light-blue-tint animate-fade-in-up">
            <h2 class="text-3xl lg:text-4xl font-bold mb-8 text-center flex items-center justify-center">
                <i class="fas fa-money-bill-wave text-yellow-500 mr-3"></i>Entry Fee & Prize Distribution
            </h2>
            <div class="overflow-x-auto">
                <table class="min-w-full rounded-lg shadow-sm">
                    <thead>
                        <tr class="uppercase text-sm leading-normal">
                            <th class="py-4 px-6 text-left rounded-tl-lg">Match Type</th>
                            <th class="py-4 px-6 text-left">Entry Fee</th>
                            <th class="py-4 px-6 text-left">Example (Players)</th>
                            <th class="py-4 px-6 text-left">Total Fee</th>
                            <th class="py-4 px-6 text-left">Prize Pool</th>
                            <th class="py-4 px-6 text-left rounded-tr-lg">Prize Distribution</th>
                        </tr>
                    </thead>
                    <tbody id="prizeTableBody" class="text-base font-light">
                        <tr>
                            <td colspan="6" class="py-6 text-center text-gray-600" id="loadingPrizeMessage">Loading prize information...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <p id="noPrizeMessage" class="hidden text-center text-gray-600 mt-6">No prize distribution information configured yet.</p>
        </section>

        <section class="w-full mb-12 card-base section-light-green-tint animate-fade-in-up">
            <h2 class="text-3xl lg:text-4xl font-bold mb-8 text-center flex items-center justify-center">
                <i class="fas fa-book text-red-500 mr-3"></i>Tournament Rules & Conditions
            </h2>
            <div id="rulesContent" class="direct-content-area">
                <p class="text-center text-gray-600">Loading rules...</p>
            </div>
        </section>

        <section class="w-full card-base section-light-orange-tint animate-fade-in-up">
            <h2 class="text-3xl lg:text-4xl font-bold mb-8 text-center flex items-center justify-center">
                <i class="fas fa-headset text-teal-500 mr-3"></i>Contact & Support
            </h2>
            <div id="contactContent" class="direct-content-area">
                <p class="text-center text-gray-600">Loading contact information...</p>
            </div>
        </section>

    </div>

    <div id="customModal" class="custom-modal">
        <div class="custom-modal-content w-full max-w-md mx-auto">
            <span class="custom-modal-close-button" onclick="closeModal()">&times;</span>
            <div id="modalContent" class="py-6 px-4 sm:px-6">
                </div>
            <div id="modalButtons" class="mt-8 flex justify-center space-x-4">
                <button id="modalConfirmBtn" class="hidden btn-primary-modal">
                    Confirm
                </button>
                <button id="modalCancelBtn" class="hidden btn-secondary-modal" onclick="closeModal()">
                    Cancel
                </button>
                <button id="modalOkBtn" class="btn-primary-modal" onclick="closeModal()">
                    OK
                </button>
            </div>
        </div>
    </div>

    <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyD48ch2_ZWn2XPuV-G6wU4Wm3BI1YVGASw",
        authDomain: "tournaments-a652c.firebaseapp.com",
        projectId: "tournaments-a652c",
        storageBucket: "tournaments-a652c.appspot.com",
        messagingSenderId: "989795533335",
        appId: "1:989795533335:web:b45cb8f8c7853b7f1e5252",
        measurementId: "G-M3XGTFTQ4G"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    let currentUser = null;
    let currentMaxTeammates = 0; // To track max teammates based on match type
    
    // ===== TIMER FUNCTIONS =====
    // Global array to store timer references
    let activeTimers = [];
    
    // Function to calculate time until match starts
    function getTimeUntilMatch(matchTimeStr) {
        const now = new Date();
        const [hours, minutes] = matchTimeStr.split(':').map(Number);
        
        // Create match date (today at specified time)
        const matchDate = new Date();
        matchDate.setHours(hours, minutes, 0, 0);
        
        // If match time has already passed today, set to tomorrow
        if (matchDate < now) {
            matchDate.setDate(matchDate.getDate() + 1);
        }
        
        // Calculate difference in milliseconds
        const diff = matchDate - now;
        
        // Calculate hours, minutes, seconds
        const hoursLeft = Math.floor(diff / (1000 * 60 * 60));
        const minutesLeft = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
        const secondsLeft = Math.floor((diff % (1000 * 60)) / 1000);
        
        return {
            hours: hoursLeft,
            minutes: minutesLeft,
            seconds: secondsLeft,
            matchDate: matchDate
        };
    }
    
    // Function to format time values with leading zeros
    function formatTimeUnit(value) {
        return value.toString().padStart(2, '0');
    }
    
    // Function to start timer for a match card
    function startMatchTimer(matchId, matchTime) {
        const timerElement = document.getElementById(`timer-${matchId}`);
        if (!timerElement) return;
        
        const timerInterval = setInterval(() => {
            const timeData = getTimeUntilMatch(matchTime);
            
            // Check if match has started
            if (timeData.hours <= 0 && timeData.minutes <= 0 && timeData.seconds <= 0) {
                timerElement.innerHTML = `<span class="text-red-500">Match Started!</span>`;
                clearInterval(timerInterval);
                return;
            }
            
            // Check if match is within 30 minutes
            if (timeData.hours === 0 && timeData.minutes < 30) {
                timerElement.innerHTML = `
                    <span class="text-orange-500 font-bold">
                        ${formatTimeUnit(timeData.minutes)}m ${formatTimeUnit(timeData.seconds)}s
                    </span>
                `;
            } 
            // More than 30 minutes remaining
            else {
                timerElement.innerHTML = `
                    <span class="text-green-600">
                        ${formatTimeUnit(timeData.hours)}h ${formatTimeUnit(timeData.minutes)}m
                    </span>
                `;
            }
        }, 1000);
        
        // Store timer reference
        activeTimers.push({
            id: matchId,
            interval: timerInterval
        });
    }
    
    // Function to clear all timers when page unloads
    function clearAllTimers() {
        activeTimers.forEach(timer => clearInterval(timer.interval));
        activeTimers = [];
    }
    
    // ===== MODAL FUNCTIONS =====
    window.openModal = (messageHtml, type = 'ok') => {
        return new Promise((resolve) => {
            const modalContentEl = document.getElementById('modalContent');
            const customModalEl = document.getElementById('customModal');
            const modalOkBtn = document.getElementById('modalOkBtn');
            const modalConfirmBtn = document.getElementById('modalConfirmBtn');
            const modalCancelBtn = document.getElementById('modalCancelBtn');

            if (!modalContentEl || !customModalEl || !modalOkBtn || !modalConfirmBtn || !modalCancelBtn) {
                console.error("Modal elements not found");
                resolve(false);
                return;
            }

            modalContentEl.innerHTML = `<p class="text-xl font-semibold text-gray-700">${messageHtml}</p>`;
            
            // Reset button states
            modalOkBtn.classList.add('hidden');
            modalConfirmBtn.classList.add('hidden');
            modalCancelBtn.classList.add('hidden');

            // Configure buttons based on modal type
            if (type === 'confirm_cancel') {
                modalConfirmBtn.classList.remove('hidden');
                modalCancelBtn.classList.remove('hidden');
                modalConfirmBtn.onclick = () => { closeModal(); resolve(true); };
                modalCancelBtn.onclick = () => { closeModal(); resolve(false); };
            } else {
                modalOkBtn.classList.remove('hidden');
                modalOkBtn.onclick = () => { closeModal(); resolve(true); };
            }
            
            customModalEl.classList.add('flex');
        });
    };

    window.closeModal = () => {
        const customModalEl = document.getElementById('customModal');
        if (customModalEl) customModalEl.classList.remove('flex');
    };

    // ===== AUTH MODALS =====
    const showLoginRegisterModal = () => {
        document.getElementById('modalContent').innerHTML = `
            <h3 class="text-2xl font-bold text-blue-500 mb-6">Login / Register</h3>
            <form id="authForm" class="space-y-4">
                <div>
                    <label for="authEmail" class="block text-gray-700 text-sm font-bold mb-2">Email:</label>
                    <input type="email" id="authEmail" class="shadow appearance-none border rounded-lg w-full py-2 px-3" placeholder="your@example.com" required>
                </div>
                <div>
                    <label for="authPassword" class="block text-gray-700 text-sm font-bold mb-2">Password:</label>
                    <input type="password" id="authPassword" class="shadow appearance-none border rounded-lg w-full py-2 px-3" placeholder="Minimum 6 characters" required>
                </div>
                <button type="submit" id="loginBtn" class="modern-btn w-full">
                    Login <i class="fas fa-sign-in-alt ml-2"></i>
                </button>
                <button type="button" id="registerNewBtn" class="modern-btn !bg-green-600 hover:!bg-green-600 w-full mt-2">
                    Register New Account <i class="fas fa-user-plus ml-2"></i>
                </button>
            </form>
            <p id="authError" class="text-red-500 text-sm mt-4"></p>
        `;
        document.getElementById('customModal').classList.add('flex'); // Show modal

        document.getElementById('authForm').addEventListener('submit', (e) => {
            e.preventDefault();
            handleAuth(document.getElementById('authEmail').value, document.getElementById('authPassword').value, 'login');
        });
        document.getElementById('registerNewBtn').addEventListener('click', () => {
            handleAuth(document.getElementById('authEmail').value, document.getElementById('authPassword').value, 'register');
        });
    };

    const handleAuth = async (email, password, type) => {
        const authError = document.getElementById('authError');
        authError.textContent = ''; // Clear previous errors

        try {
            if (type === 'login') {
                await signInWithEmailAndPassword(auth, email, password);
                await openModal('Login successful!', 'ok');
                closeModal(); // Close the auth modal
            } else { // type === 'register'
                await createUserWithEmailAndPassword(auth, email, password);
                await openModal('Registration successful! You are now logged in.', 'ok');
                closeModal(); // Close the auth modal
            }
        } catch (error) {
            let errorMessage = 'An unknown error occurred.';
            switch (error.code) {
                case 'auth/user-not-found':
                case 'auth/wrong-password':
                case 'auth/invalid-credential': // More generic for newer Firebase versions
                    errorMessage = 'Invalid email or password.';
                    break;
                case 'auth/email-already-in-use':
                    errorMessage = 'This email is already registered. Try logging in.';
                    break;
                case 'auth/weak-password':
                    errorMessage = 'Password is too weak. It must be at least 6 characters.';
                    break;
                case 'auth/invalid-email':
                    errorMessage = 'Invalid email address format.';
                    break;
                default:
                    console.error("Auth error:", error.code, error.message);
                    errorMessage = `Authentication failed: ${error.message}`;
            }
            authError.textContent = errorMessage;
        }
    };

    // ===== CORE TOURNAMENT FUNCTIONS =====

    // Helper to check if a match is open for registration (not completed and not closed)
    function isMatchOpenForRegistration(matchTimeStr) {
        try {
            const now = new Date();
            const [hours, minutes] = matchTimeStr.split(':').map(Number);
            const matchDateTime = new Date(now.getFullYear(), now.getMonth(), now.getDate(), hours, minutes, 0);
            // Registration closes 20 minutes before match time
            const registrationCloseTime = new Date(matchDateTime.getTime() - 20 * 60 * 1000);
            return now < registrationCloseTime;
        } catch (e) {
            console.error("Error parsing match time for registration open check:", e);
            return false;
        }
    }

    // Fetch and display active match slots
    const fetchAndDisplayMatchSlots = async () => {
        const matchesContainer = document.getElementById('matchesContainer');
        const matchSelect = document.getElementById('matchSelect');
        const loadingMatchesMessage = document.getElementById('loadingMatchesMessage');
        const noMatchesMessage = document.getElementById('noMatchesMessage');

        matchesContainer.innerHTML = ''; // Clear previous matches
        matchSelect.innerHTML = '<option value="">-- Loading Matches --</option>'; // Clear previous options
        loadingMatchesMessage.classList.remove('hidden');
        noMatchesMessage.classList.add('hidden');

        const response = await fetch('https://tha-tournaments.onrender.com/api/match_slots');
        const result = await response.json();

        loadingMatchesMessage.classList.add('hidden');

        if (result.success && result.matchSlots.length > 0) {
            const activeUpcomingMatches = result.matchSlots.filter(match => 
                match.active && isMatchOpenForRegistration(match.time)
            );

            if (activeUpcomingMatches.length > 0) {
                activeUpcomingMatches.sort((a, b) => a.time.localeCompare(b.time)); // Sort by time

                matchesContainer.innerHTML = ''; // Ensure cleared if loading message was there

                matchSelect.innerHTML = '<option value="">-- Select Match Type & Time --</option>'; // Default option
                activeUpcomingMatches.forEach(match => {
                    // Calculate match status
                    const timeData = getTimeUntilMatch(match.time);
                    let timerHtml = '';
                    
                    if (timeData.hours <= 0 && timeData.minutes <= 0 && timeData.seconds <= 0) {
                        timerHtml = `<p class="text-lg font-bold text-red-500">Match Started!</p>`;
                    } else {
                        timerHtml = `
                            <p class="text-sm font-semibold text-gray-600">Starts in:</p>
                            <p id="timer-${match.id}" class="text-lg font-bold text-green-600">
                                ${formatTimeUnit(timeData.hours)}h ${formatTimeUnit(timeData.minutes)}m
                            </p>
                        `;
                    }
                    
                    const cardHtml = `
                        <div class="card-base p-8 border-l-4 border-blue-300 transform transition duration-300 hover:scale-105">
                            <h3 class="text-2xl font-bold text-blue-600 mb-2">${match.type}</h3>
                            <p class="text-gray-700 mb-1"><i class="fas fa-clock mr-2 text-blue-500"></i>Time: <span class="font-semibold">${match.time}</span></p>
                            <p class="text-gray-700 mb-1"><i class="fas fa-users mr-2 text-purple-500"></i>Players: <span class="font-semibold">${match.min_players} - ${match.max_players}</span></p>
                            <p class="text-gray-700 mb-1"><i class="fas fa-rupee-sign mr-2 text-yellow-500"></i>Entry: <span class="font-semibold">â‚¹${(match.entry || 0).toFixed(2)}</span></p>
                            <p class="text-gray-700"><i class="fas fa-trophy mr-2 text-orange-400"></i>Prize: <span class="font-semibold">${match.prize || 'N/A'}</span></p>
                            
                            <div class="mt-4 text-center">
                                ${timerHtml}
                            </div>
                            
                            <button data-match-id="${match.id}" data-match-type="${match.type}" data-match-time="${match.time}" 
                                    class="register-btn mt-6 modern-btn w-full">
                                Register Now!
                            </button>
                        </div>
                    `;
                    matchesContainer.insertAdjacentHTML('beforeend', cardHtml);
                    matchSelect.insertAdjacentHTML('beforeend', `<option value="${match.id}" data-match-type="${match.type}" data-match-time="${match.time}">${match.time} - ${match.type}</option>`);
                    
                    // Start timer if match hasn't started yet
                    if (!(timeData.hours <= 0 && timeData.minutes <= 0 && timeData.seconds <= 0)) {
                        startMatchTimer(match.id, match.time);
                    }
                });

                // Add event listeners to the new "Register Now!" buttons
                document.querySelectorAll('.register-btn').forEach(button => {
                    button.addEventListener('click', () => {
                        const matchId = button.dataset.matchId;
                        // Set the selected match in the registration form dropdown
                        document.getElementById('matchSelect').value = matchId;
                        // Scroll to registration form
                        document.getElementById('registrationForm').scrollIntoView({ behavior: 'smooth' });
                        // Trigger change to update teammate section
                        const event = new Event('change');
                        document.getElementById('matchSelect').dispatchEvent(event);
                    });
                });

            } else {
                noMatchesMessage.classList.remove('hidden');
                matchSelect.innerHTML = '<option value="">-- No active matches for registration --</option>';
            }
        } else {
            noMatchesMessage.classList.remove('hidden');
            if (!result.success) {
                await openModal(result.message || 'Failed to load match slots.');
            }
        }
        // Populate dailyMatchSlots for registration form logic
        populateDailyMatchSlots(result.matchSlots);
    };

    let loadedMatchSlots = []; // Global variable to store fetched match slots

    // This function populates a global variable used by the registration form
    const populateDailyMatchSlots = (matchSlots) => {
        loadedMatchSlots = matchSlots; // Store the full list
    };

    // ===== TEAMMATE INPUT MANAGEMENT =====
    function addTeammateInput(index, isInitial = false) {
        const teammatesList = document.getElementById('teammatesList');
        const div = document.createElement('div');
        div.className = 'teammate-entry flex items-center space-x-4 mb-4';
        div.innerHTML = `
            <input type="text" class="flex-1 shadow-sm appearance-none border rounded-lg py-2 px-3" placeholder="Teammate IGN" required>
            <input type="text" class="flex-1 shadow-sm appearance-none border rounded-lg py-2 px-3" placeholder="Teammate FFID" required>
            ${isInitial ? '' : '<button type="button" class="remove-teammate-btn modern-btn !bg-red-500 hover:!bg-red-500 w-10 h-10 flex items-center justify-center"><i class="fas fa-times"></i></button>'}
        `;
        teammatesList.appendChild(div);

        // Add remove button functionality for non-initial teammates
        if (!isInitial) {
            const removeBtn = div.querySelector('.remove-teammate-btn');
            removeBtn.addEventListener('click', () => {
                div.remove();
                // Show add button again since we removed a teammate
                document.getElementById('addTeammateButton').classList.remove('hidden');
            });
        }
    }

    // Handle teammate inputs dynamically based on match type
    const updateTeammateInputs = () => {
        const matchSelect = document.getElementById('matchSelect');
        const teammatesSection = document.getElementById('teammatesSection');
        const teammatesList = document.getElementById('teammatesList');
        const addTeammateButton = document.getElementById('addTeammateButton');

        teammatesList.innerHTML = ''; // Clear existing inputs
        addTeammateButton.onclick = null; // Clear previous handler
        addTeammateButton.classList.remove('hidden'); // Show by default

        const selectedMatchId = matchSelect.value;
        const selectedMatch = loadedMatchSlots.find(slot => slot.id === selectedMatchId);

        if (selectedMatch) {
            const matchType = selectedMatch.type.toLowerCase();
            
            // Reset max teammates
            currentMaxTeammates = 0;
            
            if (matchType.includes('solo')) {
                teammatesSection.classList.add('hidden');
            } else if (matchType.includes('duo')) {
                currentMaxTeammates = 1;
                teammatesSection.classList.remove('hidden');
                // Add one initial teammate without remove button
                addTeammateInput(1, true);
                // Hide add button for duo since only one teammate is needed
                addTeammateButton.classList.add('hidden');
            } else if (matchType.includes('squad') || matchType.includes('team')) {
                currentMaxTeammates = 3;
                teammatesSection.classList.remove('hidden');
                // Add one initial teammate without remove button
                addTeammateInput(1, true);
                // Show add button for squad since we can add more teammates
                addTeammateButton.classList.remove('hidden');
            }

            // Configure add teammate button
            addTeammateButton.addEventListener('click', () => {
                const currentTeammates = teammatesList.children.length;
                if (currentTeammates < currentMaxTeammates) {
                    // Add teammate with remove button
                    addTeammateInput(currentTeammates + 1);
                    
                    // Hide button if max reached
                    if (teammatesList.children.length >= currentMaxTeammates) {
                        addTeammateButton.classList.add('hidden');
                    }
                } else {
                    openModal('You have reached the maximum number of teammates for this match type.');
                }
            });
        } else {
            teammatesSection.classList.add('hidden');
        }
    };

    // Submit Registration
    document.getElementById('registrationForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const registrationMessage = document.getElementById('registrationMessage');
        registrationMessage.classList.add('hidden'); // Hide previous message

        if (!currentUser) {
            registrationMessage.textContent = 'Please log in or register to participate.';
            registrationMessage.classList.remove('hidden');
            showLoginRegisterModal();
            return;
        }

        const matchSelect = document.getElementById('matchSelect');
        const selectedMatchId = matchSelect.value;
        const selectedMatchOption = matchSelect.options[matchSelect.selectedIndex];
        const matchType = selectedMatchOption.dataset.matchType;
        const matchTime = selectedMatchOption.dataset.matchTime;

        const iglIGN = document.getElementById('iglIGN').value;
        const iglFFID = document.getElementById('iglFFID').value;

        const teammates = [];
        const teammateIGNs = document.querySelectorAll('#teammatesList input[placeholder*="IGN"]');
        const teammateFFIDs = document.querySelectorAll('#teammatesList input[placeholder*="FFID"]');

        for (let i = 0; i < teammateIGNs.length; i++) {
            if (teammateIGNs[i].value && teammateFFIDs[i].value) {
                teammates.push({
                    ign: teammateIGNs[i].value,
                    ffid: teammateFFIDs[i].value
                });
            } else {
                await openModal('Please fill in all teammate IGNs and FFIDs, or remove empty fields.', 'ok');
                return;
            }
        }

        // Validate number of teammates based on match type
        const matchTypeLower = matchType.toLowerCase();
        let requiredTeammates = 0;
        if (matchTypeLower.includes('duo')) {
            requiredTeammates = 1;
        } else if (matchTypeLower.includes('squad') || matchTypeLower.includes('team')) {
            requiredTeammates = 3;
        }

        if (teammates.length !== requiredTeammates) {
            await openModal(`This match requires exactly ${requiredTeammates} teammate(s). You have provided ${teammates.length}.`);
            return;
        }

        const registrationData = {
            userId: currentUser.uid,
            email: currentUser.email,
            matchId: selectedMatchId,
            matchType: matchType,
            matchTime: matchTime,
            iglIGN: iglIGN,
            iglFFID: iglFFID,
            teammates: teammates,
            clientTime: new Date().toISOString()
        };

        document.getElementById('registerButton').disabled = true;
        document.getElementById('registerButton').textContent = 'Registering...';

        const response = await fetch('https://tha-tournaments.onrender.com/api/register_tournament', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(registrationData),
        });
        const result = await response.json();

        document.getElementById('registerButton').disabled = false;
        document.getElementById('registerButton').textContent = 'Register Now!';

        if (result.success) {
            await openModal(result.message);
            document.getElementById('registrationForm').reset();
            updateTeammateInputs(); // Clear teammate fields
            // Optionally redirect to registered.html
            window.location.href = '/tha-tournaments-frontend/registered.html'; 
        } else {
            await openModal(result.message || 'Registration failed. Please try again.');
        }
    });

    // ===== DYNAMIC CONTENT DISPLAY FUNCTIONS =====

    const fetchAndDisplayWebsiteContent = async () => {
    const rulesContentDiv = document.getElementById('rulesContent');
    const contactContentDiv = document.getElementById('contactContent');

    rulesContentDiv.innerHTML = '<p class="text-center text-gray-600">Loading rules...</p>';
    contactContentDiv.innerHTML = '<p class="text-center text-gray-600">Loading contact information...</p>';

    try {
        const response = await fetch('https://tha-tournaments.onrender.com/api/configs/website_content');

        if (!response.ok) {
            const text = await response.text();
            console.error("Non-JSON Response:", text);
            throw new Error(`Server returned ${response.status}`);
        }

        const result = await response.json();

        if (result.success && result.content) {
            rulesContentDiv.innerHTML = result.content.rules
                ? result.content.rules.replace(/\n/g, '<br>')
                : 'No rules yet.';
            contactContentDiv.innerHTML = result.content.contact
                ? result.content.contact.replace(/\n/g, '<br>')
                : 'No contact info yet.';
        } else {
            rulesContentDiv.innerHTML = 'Failed to load rules.';
            contactContentDiv.innerHTML = 'Failed to load contact.';
            await openModal(result.message || "No content returned.");
        }
    } catch (error) {
        console.error('Error fetching website content:', error);
        rulesContentDiv.innerHTML = 'Error loading rules.';
        contactContentDiv.innerHTML = 'Error loading contact.';
        await openModal("Backend error: " + error.message);
    }
};

    const fetchAndDisplayScheduleItems = async () => {
        const scheduleTableBody = document.getElementById('scheduleTableBody');
        const loadingScheduleMessage = document.getElementById('loadingScheduleMessage');
        const noScheduleMessage = document.getElementById('noScheduleMessage');

        scheduleTableBody.innerHTML = '';
        loadingScheduleMessage.classList.remove('hidden');
        noScheduleMessage.classList.add('hidden');

        try {
            const response = await fetch('https://tha-tournaments.onrender.com/api/schedule_items');
            const result = await response.json();

            loadingScheduleMessage.classList.add('hidden');

            if (result.success && result.scheduleItems.length > 0) {
                result.scheduleItems.sort((a, b) => a.order - b.order); // Sort by order
                result.scheduleItems.forEach(item => {
                    const row = `
                        <tr class="border-b border-gray-200 hover:bg-gray-50 transition-colors duration-200">
                            <td class="py-4 px-6 text-left font-bold text-gray-800">${item.time || 'N/A'}</td>
                            <td class="py-4 px-6 text-left">${item.description || 'N/A'}</td>
                            <td class="py-4 px-6 text-left text-gray-600">${item.notes || 'N/A'}</td>
                        </tr>
                    `;
                    scheduleTableBody.insertAdjacentHTML('beforeend', row);
                });
            } else {
                noScheduleMessage.classList.remove('hidden');
                if (!result.success) {
                    await openModal(result.message || 'Failed to load schedule items.');
                }
            }
        } catch (error) {
            console.error('Error fetching schedule items:', error);
            scheduleTableBody.innerHTML = `<tr><td colspan="3" class="py-6 text-center text-red-500">Error loading schedule.</td></tr>`;
            await openModal(`Failed to connect to backend for schedule: ${error.message}`);
        }
    };

    const fetchAndDisplayPrizeItems = async () => {
        const prizeTableBody = document.getElementById('prizeTableBody');
        const loadingPrizeMessage = document.getElementById('loadingPrizeMessage');
        const noPrizeMessage = document.getElementById('noPrizeMessage');

        prizeTableBody.innerHTML = '';
        loadingPrizeMessage.classList.remove('hidden');
        noPrizeMessage.classList.add('hidden');

        try {
            const response = await fetch('https://tha-tournaments.onrender.com/api/prize_items');
            const result = await response.json();

            loadingPrizeMessage.classList.add('hidden');

            if (result.success && result.prizeItems.length > 0) {
                result.prizeItems.sort((a, b) => a.order - b.order); // Sort by order
                result.prizeItems.forEach(item => {
                    const row = `
                        <tr class="border-b border-gray-200 hover:bg-gray-50 transition-colors duration-200">
                            <td class="py-4 px-6 text-left">${item.matchType || 'N/A'}</td>
                            <td class="py-4 px-6 text-left">${item.entryFee || 'N/A'}</td>
                            <td class="py-4 px-6 text-left">${item.totalPlayersExample || 'N/A'}</td>
                            <td class="py-4 px-6 text-left">${item.totalFee || 'N/A'}</td>
                            <td class="py-4 px-6 text-left">${item.prizePool || 'N/A'}</td>
                            <td class="py-4 px-6 text-left">${item.prizeDistribution || 'N/A'}</td>
                        </tr>
                    `;
                    prizeTableBody.insertAdjacentHTML('beforeend', row);
                });
            } else {
                noPrizeMessage.classList.remove('hidden');
                if (!result.success) {
                    await openModal(result.message || 'Failed to load prize items.');
                }
            }
        } catch (error) {
            console.error('Error fetching prize items:', error);
            prizeTableBody.innerHTML = `<tr><td colspan="6" class="py-6 text-center text-red-500">Error loading prize information.</td></tr>`;
            await openModal(`Failed to connect to backend for prize items: ${error.message}`);
        }
    };

    // ===== AUTH STATE HANDLER =====
onAuthStateChanged(auth, (user) => {
    const loadingScreen = document.getElementById('loadingScreen');
    const mainContent = document.getElementById('mainContent');
    const authButton = document.getElementById('authButton');
    const myRegistrationsButton = document.getElementById('myRegistrationsButton');
    const logoutButton = document.getElementById('logoutButton');
    const loggedInEmailSpan = document.getElementById('loggedInEmail');
    const loggedInUserInfo = document.getElementById('loggedInUserInfo');
    const regEmail = document.getElementById('regEmail');
    const regUserId = document.getElementById('regUserId');
    const loginPrompt = document.getElementById('loginPrompt');
    const registerButton = document.getElementById('registerButton');
    
    // Always show content after auth check
    if (loadingScreen) loadingScreen.classList.add('hidden');
    if (mainContent) mainContent.classList.remove('hidden');
    
    currentUser = user;
    if (user) {
        // âœ… Show logout and registrations buttons
        if (logoutButton) logoutButton.classList.remove('hidden');
        if (myRegistrationsButton) myRegistrationsButton.classList.remove('hidden');
    } else {
        // âŒ Hide if not logged in
        if (logoutButton) logoutButton.classList.add('hidden');
        if (myRegistrationsButton) myRegistrationsButton.classList.add('hidden');
    }
    if (user) {
        if (loggedInEmailSpan) loggedInEmailSpan.textContent = user.email;
        if (logoutButton) logoutButton.classList.remove('hidden');
        
        // Update the registration form with logged-in user info
        if (loggedInUserInfo) loggedInUserInfo.classList.remove('hidden');
        if (regEmail) regEmail.textContent = user.email;
        if (regUserId) regUserId.textContent = user.uid;
        if (loginPrompt) loginPrompt.classList.add('hidden');
        if (registerButton) registerButton.disabled = false;
        
        // Set logout handler
        if (logoutButton) {
            logoutButton.onclick = async () => {
                try {
                    await signOut(auth);
                    window.location.href = '/';
                } catch (error) {
                    console.error("Logout error:", error);
                    await openModal("Logout failed");
                }
            };
        }
        
    } else {
        if (loggedInEmailSpan) loggedInEmailSpan.textContent = 'Guest';
        if (logoutButton) logoutButton.classList.add('hidden');
        
        // Update registration form to prompt login
        if (loggedInUserInfo) loggedInUserInfo.classList.add('hidden');
        if (loginPrompt) loginPrompt.classList.remove('hidden');
        if (registerButton) registerButton.disabled = true;
        if (authButton) authButton.onclick = showLoginRegisterModal;
    }
});

    // ===== EVENT LISTENERS AND INITIAL LOAD =====
    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('matchSelect').addEventListener('change', updateTeammateInputs);

        // Initial fetches for dynamic content
        fetchAndDisplayMatchSlots(); // This also populates matchSelect and `loadedMatchSlots`
        fetchAndDisplayWebsiteContent();
        fetchAndDisplayScheduleItems();
        fetchAndDisplayPrizeItems();
        
        // Clear timers when page is unloaded
        window.addEventListener('beforeunload', clearAllTimers);
    });
</script>
</body>
</html>
